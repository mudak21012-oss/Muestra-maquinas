<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Catálogo de Impresoras — HUB de comparación</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* ========= TEMA OSCURO SIMPLE ========= */
    :root{
      --bg:#0b0f17; --bg-grad: radial-gradient(70vw 40vh at 20% -10%, #132133 0%, transparent 60%), var(--bg);
      --panel:#0e1421; --line:#1f2937; --text:#e6ecff; --muted:#a3acb9;
      --radius:12px; --radius-lg:16px; --shadow:0 6px 28px rgba(0,0,0,.35);
      --primary-col:#131d2f; --accent:#7aa2ff; --accent2:#00ffd0;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg-grad);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial}
    a{color:inherit;text-decoration:none}
    :focus-visible{outline:0;box-shadow:0 0 0 3px rgba(122,162,255,.35);border-radius:8px}

    /* Header minimal */
    header{position:sticky;top:0;z-index:10;background:rgba(11,15,23,.85);backdrop-filter:blur(6px);border-bottom:1px solid var(--line)}
    h1{margin:12px;text-align:center;font-size:clamp(20px,4vw,36px);font-weight:800;
       background:linear-gradient(90deg,#9ae6ff 0%, var(--accent) 40%, var(--accent2) 80%);
       -webkit-background-clip:text;background-clip:text;color:transparent;}

    /* Layout principal */
    .layout{display:grid;grid-template-columns:340px 1fr;gap:12px;padding:12px}
    @media (max-width:960px){.layout{grid-template-columns:1fr}}

    /* Lista rápida */
    .quick{border:1px solid var(--line);border-radius:var(--radius-lg);background:var(--panel);box-shadow:var(--shadow);overflow:hidden;display:grid;grid-template-rows:auto 1fr}
    .quick header{padding:8px 10px;border-bottom:1px solid var(--line);background:rgba(18,24,38,.6)}
    .q-top{display:flex;align-items:center;gap:8px;justify-content:space-between;margin-bottom:6px}
    .q-title{font-weight:700}
    .status{font-size:.8rem;color:var(--text);background:#0b1324;border:1px solid var(--line);border-radius:10px;padding:.15rem .45rem;white-space:nowrap}
    .input{width:100%;padding:.52rem .68rem;background:#0d1422;color:var(--text);border:1px solid #223047;border-radius:10px}
    .quick ul{list-style:none;margin:0;padding:0;max-height:60vh;overflow:auto}
    .quick li{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;padding:8px 12px;border-bottom:1px dashed rgba(255,255,255,.06);cursor:pointer}
    .quick li[aria-current="true"]{background:#0f172a}
    .name{font-size:.95rem}
    .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:2px}
    .chip{display:inline-flex;padding:.05rem .4rem;border-radius:999px;border:1px solid var(--line);background:#141a25;font-size:.75rem;color:#cfd8ea}
    .price{font-weight:700;font-size:.95rem}

    /* Panel derecha */
    .panel{border:1px solid var(--line);border-radius:var(--radius-lg);background:var(--panel);box-shadow:var(--shadow)}
    .panel .panel-head{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:10px 12px;border-bottom:1px solid var(--line)}
    .panel .panel-body{padding:12px}
    .btn{display:inline-flex;align-items:center;gap:.35rem;padding:.5rem .8rem;border:1px solid #2b3b57;border-radius:10px;background:linear-gradient(135deg,#0f172a,#111827);color:var(--text);cursor:pointer}
    .btn-cta{border:0;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#08111f;font-weight:800;letter-spacing:.15px;box-shadow:0 6px 20px rgba(0,0,0,.35);padding:.6rem 1rem;border-radius:12px}
    .btn-cta:hover{filter:brightness(1.05)}
    .btn-ghost{background:#0b1324;border:1px solid #223047}

    /* Tarjeta: 2 columnas (carrusel | info+features) */
    .card{display:grid;grid-template-columns:minmax(280px,1.2fr) 1.8fr;gap:12px;border:1px solid var(--line);border-radius:12px;background:#0d1117;padding:10px}
    @media (max-width:980px){.card{grid-template-columns:1fr}}

    /* Carousel con “slice” */
    .carousel{position:relative;background:#0f1524;aspect-ratio:4/3;border-radius:12px;overflow:hidden;border:1px solid #223047;display:grid;place-items:center}
    .carousel .stage{position:relative;width:100%;height:100%}
    .carousel img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;object-position:center;display:block}
    .carousel .img-top{z-index:2;clip-path:inset(0 100% 0 0)}
    @keyframes sliceIn{from{clip-path:inset(0 100% 0 0)}to{clip-path:inset(0 0 0 0)}}
    .carousel .slice-in{animation:sliceIn .45s ease forwards}
    .carousel .nav{position:absolute;top:50%;transform:translateY(-50%);background:#0b1324;border:1px solid #223047;border-radius:999px;padding:.25rem .5rem;z-index:3}
    .carousel .prev{left:.5rem}.carousel .next{right:.5rem}
    .carousel .indicator{position:absolute;bottom:.45rem;left:50%;transform:translateX(-50%);font-size:.8rem;padding:.1rem .6rem;border:1px solid #223047;border-radius:999px;background:#0b1324;z-index:3}

    .title{margin:.1rem 0;font-size:1.1rem;font-weight:800}
    .desc{margin:.15rem 0 .35rem 0;color:var(--muted)}
    .tags{display:flex;flex-wrap:wrap;gap:.35rem;margin:.2rem 0}
    .tag{display:inline-flex;padding:.12rem .5rem;border-radius:999px;background:#0f172a;border:1px solid #223047;font-size:.78rem;color:#cfd8ea}
    .suggestion{display:flex;align-items:center;gap:.5rem;padding:.4rem .6rem;border:1px solid #223047;border-radius:10px;background:#0c121f;font-size:.92rem;margin:.35rem 0}
    .suggestion small{color:var(--muted);font-size:.78rem}
    .actions{display:flex;gap:.6rem;flex-wrap:wrap;margin:.35rem 0 .6rem 0}

    /* Features ahora dentro de la misma columna (no lateral) */
    .features-panel{border:1px solid #223047;border-radius:10px;background:#0f1524;padding:10px}
    .features-panel h4{margin:0 0 6px 0;font-size:.95rem}
    .features{margin:0 0 .1rem 1.1rem}
    .updated{color:var(--muted);margin-top:.35rem}

    /* HUB de comparación (pantalla completa con scroll robusto) */
    .hub[hidden]{display:none}
    .hub{position:fixed;inset:0;background:rgba(5,7,10,.7);backdrop-filter:blur(6px);display:grid;place-items:center;z-index:1000}
    .hub__content{
      width:min(1200px,96vw);height:min(90vh,1000px);
      border:1px solid var(--line);border-radius:16px;background:var(--panel);box-shadow:var(--shadow);
      display:grid;grid-template-rows:auto 1fr;min-height:0; /* permite scroll interno */
    }
    .hub__head{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:10px 12px;border-bottom:1px solid var(--line)}
    .pill{background:#0b1324;border:1px solid var(--line);border-radius:999px;padding:.25rem .6rem;font-size:.82rem}
    .hub__body{display:grid;grid-template-columns:360px 1fr;gap:12px;padding:12px;min-height:0}
    @media (max-width:960px){.hub__body{grid-template-columns:1fr}}
    .hub__side{display:grid;grid-template-rows:auto auto 1fr auto;gap:8px;min-height:0}
    .hub__search{padding:.5rem .6rem;background:#0d1422;color:var(--text);border:1px solid #223047;border-radius:10px;width:100%}
    .hub__list{border:1px solid var(--line);border-radius:12px;background:#0d1117;overflow:auto;min-height:0}
    .hub__item{display:flex;gap:.5rem;align-items:center;padding:8px;border-bottom:1px dashed rgba(255,255,255,.06)}
    .hub__item:last-child{border-bottom:0}
    .hub__main{min-width:0;min-height:0;overflow:auto} /* scroll vertical */
    .compare-wrap{overflow:auto;border:1px solid var(--line);border-radius: var(--radius);background:#0d1117}
    table.compare{border-collapse:separate;border-spacing:0;width:100%;min-width:720px}
    .compare th,.compare td{border-bottom:1px solid var(--line);padding:.52rem .6rem;vertical-align:top;background:transparent;font-size:.92rem}
    .compare thead th{position:sticky;top:0;background:#0f1524;z-index:1}
    .sticky{position:sticky;left:0;background:#0f1524;z-index:2;border-right:1px solid var(--line);min-width:170px}
    .is-primary-col{background:var(--primary-col)!important;box-shadow: inset 0 0 0 1px rgba(122,162,255,.35)}
  </style>
</head>
<body>
  <header><h1>Catálogo de Impresoras</h1></header>

  <main class="layout">
    <!-- Lista rápida (buscador arriba que filtra en vivo) -->
    <aside class="quick" aria-label="Lista rápida">
      <header>
        <div class="q-top">
          <div class="q-title">Resultados</div>
          <div id="status" class="status" role="status" aria-live="polite">Cargando…</div>
        </div>
        <input id="searchInput" class="input" type="search" placeholder="Buscar por marca, modelo o características — usa /" aria-label="Buscar" />
      </header>
      <ul id="quickList"></ul>
    </aside>

    <!-- Detalle -->
    <section class="panel" aria-label="Impresora seleccionada">
      <div class="panel-head"><strong>Impresora seleccionada</strong></div>
      <div class="panel-body"><div id="primaryContainer"></div></div>
    </section>
  </main>

  <!-- HUB de comparación -->
  <section id="compareHub" class="hub" role="dialog" aria-modal="true" aria-labelledby="hubTitle" hidden>
    <div class="hub__content" role="document">
      <div class="hub__head">
        <div>
          <strong id="hubTitle">Comparar productos</strong>
          <span class="pill" id="hubCount">0 seleccionados (máx. 3 además del principal)</span>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="hubClear" class="btn btn-ghost" type="button">Limpiar</button>
          <button id="hubClose" class="btn btn-ghost" type="button">Cerrar</button>
        </div>
      </div>
      <div class="hub__body">
        <aside class="hub__side">
          <span class="pill">Incluye siempre la impresora seleccionada</span>
          <input id="hubSearch" class="hub__search" placeholder="Buscar en catálogo…" aria-label="Buscar en lista" />
          <div id="hubList" class="hub__list" role="listbox" aria-label="Listado para comparar"></div>
          <small class="pill" style="justify-self:start">Clic o barra espaciadora para (des)seleccionar</small>
        </aside>
        <div class="hub__main">
          <div id="hubTableWrap" class="compare-wrap" aria-live="polite"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Tarjeta -->
  <template id="tpl-card">
    <article class="card">
      <!-- Col 1: carrusel -->
      <div class="carousel" tabindex="0" aria-label="Galería de imágenes" aria-live="polite">
        <div class="stage">
          <img class="img-bottom" alt="" />
          <img class="img-top" alt="" />
        </div>
        <button class="btn nav prev" type="button" aria-label="Imagen anterior">◀</button>
        <div class="indicator" aria-live="polite" aria-atomic="true">1/1</div>
        <button class="btn nav next" type="button" aria-label="Imagen siguiente">▶</button>
      </div>

      <!-- Col 2: info + features en la misma sección -->
      <div>
        <h3 class="title"><span class="name"></span></h3>
        <p class="desc"></p>
        <div class="tags">
          <span class="tag brand"></span>
          <span class="tag type"></span>
          <span class="tag stock"></span>
          <span class="tag price"></span>
        </div>
        <div class="suggestion">
          <span class="suggestion-text"></span>
          <small class="suggestion-source"></small>
        </div>
        <div class="actions">
          <a class="btn-cta link" target="_blank" rel="noopener">Ver producto →</a>
          <button class="btn compare-open" type="button">Comparar productos</button>
        </div>

        <div class="features-panel">
          <h4>Características</h4>
          <ul class="features"></ul>
          <div class="updated">Última actualización: <span class="updated-date"></span></div>
        </div>
      </div>
    </article>
  </template>

  <script>
    /* ========= Config ========= */
    const CONFIG = {
      FORCE_SOURCE: "csv",
      SHEET_JSON_URL: "https://script.google.com/.../exec",
      SHEET_CSV_URL: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTZ-GFIahnmzB09C1GWCvAs1PaNXmpN2_Ed5taWtseTRlqx0P8-ZKJ28TOsvziFOw/pub?gid=128232950&single=true&output=csv",
      TEMPORADA_CLASES: { inicio: "2025-02-15", fin: "2025-03-31" },
      CACHE_TTL_MS: 1000 * 60 * 60 * 6,
      HEADER_ALIASES: {
        id:["ID","uuid","Uid","id_producto"], marca:["Marca","brand","Brand","Fabricante"],
        modelo:["Modelo","model","Model"], nombre:["Nombre","titulo","Título","producto","Producto"],
        tipo:["Tipo","tecnologia","Tecnología","technology","Tecnologia"],
        descripcion_corta:["descripcion","Descripción","descripcion breve","Descripción corta","resumen"],
        caracteristicas:["caracteristicas","Características","features","especificaciones","atributos"],
        imagenes:["imagenes","Imágenes","fotos","Fotos","images","image_urls","galeria","Galería","Imagen 1","Imagen1"],
        precio:["Precio","price","Price","importe","valor","coste","costo"], moneda:["Moneda","currency","Currency"],
        url_producto:["url","URL","enlace","link","Link","url producto","URL producto","producto_url"],
        stock:["Stock","disponibilidad","availability","inventario","estado stock"],
        uso_recomendado:["uso","Uso","segmento","Uso recomendado","target"],
        sugerencia_compra:["sugerencia","Sugerencia compra","recomendacion","Recomendación"],
        ultima_actualizacion:["Última actualización","actualizado","update_date","last_update","fecha actualización"],
      },
    };
    const CACHE_KEY = "impresorasCache:hub:v3";
    const MAX_IMAGES_PER_CARD = 6;
    const MAX_COMPARE_TOTAL = 4; // 1 principal + 3
    const MAX_QUICKLIST = 250;

    /* ========= Estado ========= */
    const state = { items:[], medianaPorGrupo:{}, search:"", selectedId:"", compareIds:[], hubSearch:"" };

    /* ========= Utils ========= */
    const $=(s,r=document)=>r.querySelector(s);
    const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
    const debounce=(fn,d=150)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),d);};};
    const withinDateRange=(_d,r)=>{const t=new Date(),s=new Date(r.inicio+"T00:00:00"),e=new Date(r.fin+"T23:59:59");return t>=s&&t<=e;};
    function parsePrice(v){if(v==null||v==="")return null;const s=String(v).trim().replace(/\s+/g,"").replace(/(?<=\d)[.,](?=\d{3}\b)/g,"").replace(",",".");const n=Number(s);return Number.isFinite(n)?n:null;}
    function formatPrice(n,c){if(n==null)return"";try{if(c)return new Intl.NumberFormat(undefined,{style:"currency",currency:c}).format(n);}catch(_){ }return new Intl.NumberFormat(undefined).format(n)+(c?` ${c}`:"");}
    function parseCSVToObjects(txt){const rows=[];let i=0,field="",row=[],q=false;const endF=()=>{row.push(field);field="";},endR=()=>{rows.push(row);row=[];};while(i<txt.length){const c=txt[i];if(q){if(c=='"'){if(txt[i+1]=='"'){field+='"';i++;}else q=false;}else field+=c;}else{if(c=='"')q=true;else if(c==",")endF();else if(c=="\n"){endF();endR();}else if(c!="\r")field+=c;}i++;}endF();endR();const headers=rows.shift()?.map(h=>(h||"").trim())||[];return rows.filter(r=>r.some(v=>(v||"").trim()!=="")).map(r=>{const o={};headers.forEach((h,idx)=>o[h]=(r[idx]??"").trim());return o;});}
    const initials=(a,b="")=>{const p=[a,b].filter(Boolean).join(" ").split(/\s+/).filter(Boolean);return (p[0]?.[0]||"P").toUpperCase()+(p[1]?.[0]||"R").toUpperCase();};
    const placeholderDataURI=(t="PR")=>"data:image/svg+xml;charset=utf-8,"+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="800"><rect width="100%" height="100%" fill="#101826"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="system-ui" font-size="160" fill="#6b7280" font-weight="700">${t}</text></svg>`);
    const escapeHTML=s=>s.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;");
    const _normKey=s=>String(s||"").normalize?.("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9]+/g,"").trim();
    const _buildHeaderIndex=r=>{const i={};Object.keys(r||{}).forEach(k=>i[_normKey(k)]=k);return i;};
    const _makeReader=idx=>(row,want)=>{const c=[want,...(CONFIG.HEADER_ALIASES?.[want]||[])];for(const w of c){const real=idx[_normKey(w)];if(real&&row[real]!=null&&String(row[real]).trim()!=="")return String(row[real]).trim();}return "";};
    function _extractImages(row,idx){const d=_makeReader(idx)(row,"imagenes");if(d)return d;const imgs=[];for(const k of Object.keys(row)){const nk=_normKey(k);if(nk.startsWith("imagen")||nk.startsWith("foto")||nk.startsWith("image")){const v=String(row[k]??"").trim();if(v)imgs.push(v);}}return imgs.join(", ");}
    function _extractFeatures(row,idx){const d=_makeReader(idx)(row,"caracteristicas");if(d)return d;const fs=[];for(const k of Object.keys(row)){const nk=_normKey(k);if(nk.startsWith("caracteristica")||nk.startsWith("feature")||nk==="caracteristicas"){const v=String(row[k]??"").trim();if(v)fs.push(v);} }return fs.join("|");}
    const _normalizeStock=s=>{const v=String(s||"").toLowerCase();if(!v)return"";if(/(sin\s*stock|agotad|no\s*disponible)/.test(v))return"sin_stock";if(/(bajo|poco)/.test(v))return"bajo";if(/(pedido|order)/.test(v))return"bajo_pedido";if(/(en\s*stock|disponible|stock)/.test(v))return"en_stock";return v;};
    function remapRowsWithAliases(rows){if(!rows||!rows.length)return rows;const idx=_buildHeaderIndex(rows[0]),read=_makeReader(idx);
      return rows.map(r=>({...r,
        id:read(r,"id")||r.id,marca:read(r,"marca")||r.marca,modelo:read(r,"modelo")||r.modelo,
        nombre:read(r,"nombre")||r.nombre,tipo:read(r,"tipo")||r.tipo,descripcion_corta:read(r,"descripcion_corta")||r.descripcion_corta,
        caracteristicas:_extractFeatures(r,idx),imagenes:_extractImages(r,idx),precio:read(r,"precio")||r.precio,moneda:read(r,"moneda")||r.moneda,
        url_producto:read(r,"url_producto")||r.url_producto||read(r,"url")||"",stock:_normalizeStock(read(r,"stock")||r.stock),
        uso_recomendado:read(r,"uso_recomendado")||r.uso_recomendado,sugerencia_compra:read(r,"sugerencia_compra")||r.sugerencia_compra,ultima_actualizacion:read(r,"ultima_actualizacion")||r.ultima_actualizacion
      }));}

    /* ========= Fetch + cache ========= */
    async function tryFetchJSON(url){if(!url||url.includes(".../exec"))throw new Error("JSON URL placeholder");const r=await fetch(url,{headers:{"Accept":"application/json"}});if(!r.ok)throw new Error("HTTP "+r.status);const d=await r.json();const rows=Array.isArray(d)?d:(Array.isArray(d.data)?d.data:[]);if(!rows.length)throw new Error("JSON vacío");return rows;}
    async function tryFetchCSV(url){const bust=url+(url.includes("?")?"&":"?")+"_cb="+Date.now();const r=await fetch(bust,{headers:{"Accept":"text/csv"}});if(!r.ok)throw new Error("HTTP "+r.status);const t=await r.text();const rows=parseCSVToObjects(t);if(!rows.length)throw new Error("CSV vacío");return rows;}
    const saveCache=items=>{try{localStorage.setItem(CACHE_KEY,JSON.stringify({ts:Date.now(),items}))}catch(_){ }};
    function loadCache(){try{const raw=localStorage.getItem(CACHE_KEY);if(!raw)return null;const p=JSON.parse(raw);if(!p||!Array.isArray(p.items))return null;if(Date.now()-p.ts>CONFIG.CACHE_TTL_MS)return null;return p.items;}catch(_){return null;}}
    async function loadDataWithFallback(){
      const st=$("#status"); st.textContent="Cargando…";
      const c=loadCache(); if(c){st.textContent=`Cache (${c.length})`; return c;}
      try{
        if(CONFIG.FORCE_SOURCE==="json"){const j=await tryFetchJSON(CONFIG.SHEET_JSON_URL);st.textContent=`JSON (${j.length})`;saveCache(j);return j;}
        if(CONFIG.FORCE_SOURCE==="csv"){const v=await tryFetchCSV(CONFIG.SHEET_CSV_URL);st.textContent=`CSV (${v.length})`;saveCache(v);return v;}
        try{const j=await tryFetchJSON(CONFIG.SHEET_JSON_URL);st.textContent=`JSON (${j.length})`;saveCache(j);return j;}catch(e){st.textContent=`JSON falló → CSV…`;const v=await tryFetchCSV(CONFIG.SHEET_CSV_URL);st.textContent=`CSV (${v.length})`;saveCache(v);return v;}
      }catch(e){st.textContent=`Fallo fuentes. Demo local.`;return SAMPLE_DATA;}
    }

    /* ========= Transformación + sugerencias ========= */
    function normalizeRow(row){
      const it={...row};
      it.marca=(it.marca||"").trim(); it.modelo=(it.modelo||"").trim();
      it.nombre=(it.nombre||"").trim()||`${it.marca} ${it.modelo}`.trim();
      it.tipo=(it.tipo||"").trim(); it.descripcion_corta=(it.descripcion_corta||"").trim();
      it._features=(it.caracteristicas||"").split("|").map(x=>x.trim()).filter(Boolean);
      let imgs=(it.imagenes||"").split(",").map(x=>x.trim()).filter(Boolean);
      if(imgs.length>MAX_IMAGES_PER_CARD) imgs=imgs.slice(0,MAX_IMAGES_PER_CARD);
      if(!imgs.length) imgs=[placeholderDataURI(initials(it.marca,it.modelo))];
      it._images=imgs;
      it._precio=parsePrice(it.precio); it.moneda=(it.moneda||"").trim().toUpperCase();
      it.url_producto=(it.url_producto||"").trim(); it.stock=(it.stock||"").trim();
      it.uso_recomendado=(it.uso_recomendado||"").trim(); it.sugerencia_compra=(it.sugerencia_compra||"").trim();
      it.ultima_actualizacion=(it.ultima_actualizacion||"").trim();
      it.id=(it.id||`${it.marca}-${it.modelo}`||Math.random().toString(36).slice(2)).trim();
      return it;
    }
    const computeMedian=arr=>{if(!arr.length)return null;const a=arr.slice().sort((x,y)=>x-y);const m=Math.floor(a.length/2);return a.length%2?a[m]:(a[m-1]+a[m])/2;};
    function buildMedians(items){const g=new Map();for(const it of items){if(it._precio==null)continue;const k=`${it.marca}|${it.tipo}`;if(!g.has(k))g.set(k,[]);g.get(k).push(it._precio);}const out={};for(const [k,v]of g)out[k]=computeMedian(v);return out;}
    function computeSuggestion(it,med){
      if(it.sugerencia_compra) return {text:it.sugerencia_compra, source:"Hoja"};
      if(it.stock==="bajo") return {text:"Comprar pronto: stock limitado", source:"stock=bajo"};
      if(it.stock==="sin_stock") return {text:"Esperar reposición", source:"stock=sin_stock"};
      const key=`${it.marca}|${it.tipo}`, m=med[key];
      if(it._precio!=null && m!=null && it._precio<m) return {text:"Buen momento para comprar", source:"precio < mediana"};
      if(it.uso_recomendado==="estudiante" && withinDateRange(new Date(), CONFIG.TEMPORADA_CLASES)) return {text:"Comprar antes de inicio de clases", source:"temporada estudiantes"};
      return {text:"Comprar según necesidad", source:"sin condición específica"};
    }
    function transformAll(rows){
      const canon=remapRowsWithAliases(rows);
      const items=canon.map(normalizeRow);
      const med=buildMedians(items);
      for(const it of items){const s=computeSuggestion(it,med);it._sugerencia=s.text;it._sugerencia_source="Regla: "+s.source;}
      return {items,medians:med};
    }

    /* ========= Filtros + render ========= */
    function filteredItems(){
      const q=state.search.toLowerCase().trim();
      let out=state.items.filter(it=>{
        if(!q) return true;
        const hay=[it.marca,it.modelo,it.nombre,it.tipo,it.descripcion_corta,it._features.join(" ")].join(" ").toLowerCase();
        return hay.includes(q);
      });
      out.sort((a,b)=>a.nombre.localeCompare(b.nombre,undefined,{sensitivity:"base"}));
      return out;
    }

    function renderQuickList(){
      const ul=$("#quickList"); ul.innerHTML="";
      const items=filteredItems().slice(0,MAX_QUICKLIST);
      const frag=document.createDocumentFragment();
      for(const it of items){
        const li=document.createElement("li"); li.setAttribute("role","button"); li.tabIndex=0; li.dataset.id=it.id;
        if(it.id===state.selectedId) li.setAttribute("aria-current","true");
        li.innerHTML=`<div>
            <div class="name">${escapeHTML(it.nombre)}</div>
            <div class="chips"><span class="chip">${escapeHTML(it.marca)}</span><span class="chip">${escapeHTML(it.tipo||"")||"—"}</span></div>
          </div>
          <div class="price">${it._precio!=null?escapeHTML(formatPrice(it._precio,it.moneda)):""}</div>`;
        li.addEventListener("click", ()=>{ state.selectedId=it.id; renderPrimary(); highlightQuickList(); });
        li.addEventListener("keydown", e=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); state.selectedId=it.id; renderPrimary(); highlightQuickList(); }});
        frag.appendChild(li);
      }
      if(!items.length){ const li=document.createElement("li"); li.innerHTML='<span class="chips">Sin resultados</span>'; frag.appendChild(li); }
      ul.appendChild(frag);
      $("#status").textContent=`Resultados: ${items.length} · Total: ${state.items.length}`;
      if(!state.selectedId && items[0]){ state.selectedId=items[0].id; renderPrimary(); highlightQuickList(); }
    }
    function highlightQuickList(){ $$("#quickList li").forEach(li=>li.removeAttribute("aria-current")); const cur=$(`#quickList li[data-id="${CSS.escape(state.selectedId)}"]`); if(cur) cur.setAttribute("aria-current","true"); }

    function renderPrimary(){
      const c=$("#primaryContainer"); c.innerHTML="";
      const it=state.items.find(x=>x.id===state.selectedId);
      if(!it){ c.innerHTML='<div class="chips">Selecciona una impresora.</div>'; return; }
      const node=renderCard(it);
      $(".compare-open", node).addEventListener("click", openCompareHub);
      c.appendChild(node);
    }

    function renderCard(item){
      const tpl=$("#tpl-card"); const el=tpl.content.firstElementChild.cloneNode(true);

      /* Carrusel “slice” con dos capas */
      const stage=el.querySelector(".stage");
      const imgBottom=el.querySelector(".img-bottom");
      const imgTop=el.querySelector(".img-top");
      const prev=el.querySelector(".prev"), next=el.querySelector(".next");
      const ind=el.querySelector(".indicator");
      const images=item._images.slice(0,MAX_IMAGES_PER_CARD);
      let idx=0, activeTop=false;

      function setIndicator(){ ind.textContent=`${idx+1}/${images.length}`; }
      function setImg(target, src, alt){ target.src=src; target.alt=alt; }
      function show(index, dir=1){
        idx=(index+images.length)%images.length;
        const src=images[idx]; const alt=`Foto ${idx+1}/${images.length} — ${item.nombre}`;
        // Preparar top layer con animación
        const toAnimate = activeTop ? imgBottom : imgTop;
        const under      = activeTop ? imgTop    : imgBottom;
        setImg(toAnimate, src, alt);
        // reset anim
        toAnimate.classList.remove("slice-in");
        void toAnimate.offsetWidth; // reflow
        toAnimate.style.zIndex=2; under.style.zIndex=1;
        toAnimate.classList.add("slice-in");
        activeTop = !activeTop;
        setIndicator();
      }
      setImg(imgBottom, images[0], `Foto 1/${images.length} — ${item.nombre}`); setIndicator();
      prev.addEventListener("click", ()=>show(idx-1,-1));
      next.addEventListener("click", ()=>show(idx+1, 1));
      stage.parentElement.addEventListener("keydown",e=>{ if(e.key==="ArrowLeft"){e.preventDefault();show(idx-1,-1);} if(e.key==="ArrowRight"){e.preventDefault();show(idx+1,1);} });

      // Datos
      el.querySelector(".name").textContent=item.nombre;
      el.querySelector(".desc").textContent=item.descripcion_corta||"";
      el.querySelector(".brand").textContent=item.marca||"—";
      el.querySelector(".type").textContent=item.tipo||"—";
      el.querySelector(".stock").textContent=({en_stock:"En stock",bajo:"Stock bajo",sin_stock:"Sin stock",bajo_pedido:"Bajo pedido"}[item.stock]||item.stock||"—");
      el.querySelector(".price").textContent=item._precio!=null?formatPrice(item._precio,item.moneda):"";
      const feats=el.querySelector(".features"); feats.innerHTML=""; for(const f of item._features){ const li=document.createElement("li"); li.textContent=f; feats.appendChild(li); }
      el.querySelector(".updated-date").textContent=item.ultima_actualizacion||"—";
      const sug=el.querySelector(".suggestion"); sug.querySelector(".suggestion-text").textContent=item._sugerencia; sug.querySelector(".suggestion-source").textContent=item._sugerencia_source; sug.title=item._sugerencia_source;
      const a=el.querySelector(".link"); if(item.url_producto){ a.href=item.url_producto; } else { a.textContent="Ver producto"; a.href="javascript:void(0)"; a.setAttribute("aria-disabled","true"); }
      return el;
    }

    /* ========= HUB de comparación ========= */
    function openCompareHub(){
      const hub=$("#compareHub"); hub.hidden=false; document.body.style.overflow="hidden";
      $("#hubSearch").value = state.hubSearch || "";
      renderHub();
      setTimeout(()=>$("#hubSearch").focus(),0);
    }
    function closeCompareHub(){ $("#compareHub").hidden=true; document.body.style.overflow=""; }
    function addToCompare(ids){
      const allowedExtras = Math.max(0, MAX_COMPARE_TOTAL-1);
      for(const id of ids){
        if(!id || id===state.selectedId) continue;
        if(!state.compareIds.includes(id)){
          if(state.compareIds.length >= allowedExtras) break;
          state.compareIds.push(id);
        }
      }
    }
    function removeFromCompare(id){ state.compareIds = state.compareIds.filter(x=>x!==id); renderHub(); }

    function renderHub(){
      const q = ($("#hubSearch").value || "").toLowerCase().trim();
      state.hubSearch = q;
      const list = $("#hubList"); list.innerHTML=""; const items = state.items.filter(it=>{
        if(!q) return true;
        const hay=[it.marca,it.modelo,it.nombre,it.tipo,it._features.join(" ")].join(" ").toLowerCase();
        return hay.includes(q);
      });
      const allowedExtras = Math.max(0, MAX_COMPARE_TOTAL-1);
      const frag=document.createDocumentFragment();
      for(const it of items){
        const row=document.createElement("label"); row.className="hub__item"; row.tabIndex=0;
        const cb=document.createElement("input"); cb.type="checkbox"; cb.value=it.id;
        const isPrimary = it.id===state.selectedId;
        cb.checked = isPrimary ? true : state.compareIds.includes(it.id);
        cb.disabled = isPrimary;
        cb.addEventListener("change", ()=>{
          if(cb.checked){
            if(!isPrimary){
              if(state.compareIds.length >= allowedExtras){ cb.checked=false; return; }
              state.compareIds.push(it.id);
            }
          } else {
            state.compareIds = state.compareIds.filter(x=>x!==it.id);
          }
          renderHubMain(); updateHubCount();
        });
        row.addEventListener("keydown", (e)=>{ if(e.key===" "){ e.preventDefault(); cb.click(); }});
        const name=document.createElement("span");
        name.innerHTML = `<strong>${escapeHTML(it.nombre)}</strong> <span class="chip">${escapeHTML(it.marca)}</span>${isPrimary? ' <span class="chip">Seleccionada</span>':''}`;
        row.appendChild(cb); row.appendChild(name);
        frag.appendChild(row);
      }
      if(!items.length){ const empty=document.createElement("div"); empty.className="hub__item"; empty.innerHTML='<span class="chip">Sin resultados</span>'; frag.appendChild(empty); }
      list.appendChild(frag);
      updateHubCount(); renderHubMain();
    }
    function renderHubMain(){
      const wrap=$("#hubTableWrap"); wrap.innerHTML="";
      const primary=state.items.find(x=>x.id===state.selectedId); if(!primary){ wrap.innerHTML='<div class="pill">Selecciona primero una impresora.</div>'; return; }
      const cols=[primary, ...state.compareIds.map(id=>state.items.find(x=>x.id===id)).filter(Boolean)];
      wrap.appendChild(buildCompareTable(cols));
    }
    function updateHubCount(){ $("#hubCount").textContent = `${state.compareIds.length} seleccionados (máx. ${Math.max(0, MAX_COMPARE_TOTAL-1)} además del principal)`; }

    function buildCompareTable(items){
      const t=document.createElement("table"); t.className="compare"; const thead=t.createTHead(); const hrow=thead.insertRow();
      const h0=document.createElement("th"); h0.className="sticky"; h0.textContent="Especificación"; hrow.appendChild(h0);
      items.forEach((it,idx)=>{
        const th=document.createElement("th");
        if(idx===0) th.classList.add("is-primary-col");
        th.innerHTML=`<div><strong>${escapeHTML(it.nombre)}</strong></div>
          <div style="color:var(--muted)">${escapeHTML(it.marca)} ${escapeHTML(it.modelo)}</div>
          <div style="white-space:nowrap;margin-top:.25rem;">
            ${it.url_producto?`<a class="btn-cta" href="${it.url_producto}" target="_blank" rel="noopener">Ver producto →</a>`:`<span class="chip">Sin enlace</span>`}
            ${idx!==0?` <button class="btn btn-ghost remove-col" data-id="${it.id}" type="button">Quitar</button>`:` <span class="chip">Principal</span>`}
          </div>`;
        hrow.appendChild(th);
      });
      const tb=t.createTBody();
      const add=(label,get)=>{const tr=tb.insertRow();const th=document.createElement("th");th.className="sticky";th.textContent=label;tr.appendChild(th);
        items.forEach((it,idx)=>{const td=tr.insertCell(); const html=get(it)??"—"; td.innerHTML=html; if(idx===0) td.classList.add("is-primary-col");});
      };
      items.forEach(it=>{it._precioFmt=it._precio!=null?formatPrice(it._precio,it.moneda):"—";});
      add("Nombre", it=>escapeHTML(it.nombre));
      add("Marca", it=>escapeHTML(it.marca));
      add("Modelo", it=>escapeHTML(it.modelo));
      add("Tipo", it=>escapeHTML(it.tipo||"—"));
      add("Precio", it=>escapeHTML(it._precioFmt));
      add("Stock", it=>escapeHTML(it.stock||"—"));
      add("Uso recomendado", it=>escapeHTML(it.uso_recomendado||"—"));
      add("Sugerencia", it=>escapeHTML(it._sugerencia||"—"));
      const feats=new Set(); items.forEach(i=>i._features.forEach(f=>feats.add(f)));
      [...feats].sort((a,b)=>a.localeCompare(b)).forEach(f=> add("Caract.: "+f, it=> it._features.includes(f)?"✓":"—") );
      add("Última actualización", it=>escapeHTML(it.ultima_actualizacion||"—"));
      $$(".remove-col", t).forEach(b=>b.addEventListener("click", e=>{ removeFromCompare(e.currentTarget.dataset.id); }));
      return t;
    }

    /* ========= Eventos ========= */
    function attachEvents(){
      // Filtrado en vivo (sin menú desplegable)
      $("#searchInput").addEventListener("input", e=>{ state.search=e.target.value; updateUI(); });

      document.addEventListener("keydown",(e)=>{
        if(e.key==="/" && !/input|textarea|select/i.test(document.activeElement.tagName)){ e.preventDefault(); $("#searchInput")?.focus(); }
        if(e.altKey && (e.key==="ArrowRight"||e.key==="ArrowLeft")){
          e.preventDefault();
          const list=filteredItems(); const idx=list.findIndex(x=>x.id===state.selectedId);
          if(idx>-1 && list.length){ const nextIdx = e.key==="ArrowRight" ? (idx+1)%list.length : (idx-1+list.length)%list.length;
            state.selectedId=list[nextIdx].id; renderPrimary(); highlightQuickList(); }
        }
        if(e.key==="Escape" && !$("#compareHub").hidden) closeCompareHub();
        if(e.key.toLowerCase()==="c" && $("#compareHub").hidden) openCompareHub();
      });
      $("#hubSearch").addEventListener("input", debounce(()=>renderHub(),150));
      $("#hubClose").addEventListener("click", closeCompareHub);
      $("#hubClear").addEventListener("click", ()=>{ state.compareIds=[]; renderHub(); });
      $("#compareHub").addEventListener("click", (e)=>{ if(e.target.id==="compareHub") closeCompareHub(); });
    }
    function updateUI(){ renderQuickList(); renderPrimary(); }

    /* ========= Demo fallback ========= */
    const SAMPLE_DATA=[
      { id:"hp-415", marca:"HP", modelo:"Ink Tank 415", nombre:"", tipo:"inyeccion", descripcion_corta:"Multifunción con Wi-Fi para hogar y tareas escolares.", caracteristicas:"Wi-Fi|Imprime/Escanea/Copia|A4|Tanque de tinta", imagenes:"", precio:"149999", moneda:"ARS", url_producto:"", stock:"bajo", uso_recomendado:"estudiante", sugerencia_compra:"", ultima_actualizacion:"2025-08-01" },
      { id:"epson-l3250", marca:"Epson", modelo:"L3250", nombre:"Epson EcoTank L3250", tipo:"multifunción", descripcion_corta:"EcoTank con impresión económica y conectividad móvil.", caracteristicas:"EcoTank|Wi-Fi|Imprime/Escanea/Copia|A4", imagenes:"", precio:"189999", moneda:"ARS", url_producto:"", stock:"en_stock", uso_recomendado:"hogar", sugerencia_compra:"", ultima_actualizacion:"2025-07-20" },
      { id:"brother-hl-l2370dw", marca:"Brother", modelo:"HL-L2370DW", nombre:"", tipo:"láser", descripcion_corta:"Láser monocromática rápida con dúplex y Wi-Fi.", caracteristicas:"Láser|Dúplex|Wi-Fi|A4|Monocromo", imagenes:"", precio:"214999", moneda:"ARS", url_producto:"", stock:"sin_stock", uso_recomendado:"oficina", sugerencia_compra:"", ultima_actualizacion:"2025-08-05" },
    ];

    /* ========= Init ========= */
    (async function init(){
      try{
        const rows=await loadDataWithFallback();
        const {items,medians}=transformAll(rows);
        state.items=items; state.medianaPorGrupo=medians;
        attachEvents(); updateUI();
      }catch(err){
        console.error(err);
        $("#status").textContent="Error al cargar datos";
        $("#primaryContainer").innerHTML='<div class="chips">Ocurrió un error al obtener los datos.</div>';
      }
    })();
  </script>
</body>
</html>
