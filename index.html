<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Catálogo de Impresoras — Vista Unitaria + Comparador (HTML único)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!--
  =============================================================================
  SETUP — ¡Lee esto primero!
  =============================================================================

  OBJETIVO
  --------
  Este `index.html` es un prototipo autosuficiente (sin build ni frameworks)
  para listar impresoras desde Google Sheets y:
    - Mostrar SOLO 1 impresora a la vez (vista unitaria).
    - Permitir elegir otras impresoras por búsqueda/filtros/selector.
    - Hacer comparativas entre la impresora seleccionada y otras (tabla de comparación).

  Incluye:
    - Opción A: consumo de CSV publicado desde tu Google Sheet (ya configurado con tu URL y gid de Sheet2).
    - Opción B: API JSON servida por Google Apps Script (recomendado, con placeholder).
    - Fallback: dataset de ejemplo embebido si falla todo lo externo.
    - Cache localStorage con TTL (6h).

  ESTRUCTURA DE LA HOJA (pestaña que publiques, p. ej. "Sheet2" o "Impresoras")
  ----------------------------------------------------------------------------
  Encabezados EXACTOS (fila 1):
    id | marca | modelo | nombre | tipo | descripcion_corta | caracteristicas | imagenes
    precio | moneda | url_producto | stock | uso_recomendado | sugerencia_compra | ultima_actualizacion

  FORMATO (resumen)
  -----------------
  - caracteristicas: separadas por "|" (ej: "Wi-Fi|A3|Doble cara")
  - imagenes: URLs separadas por "," (al menos 1; si no hay, se muestra placeholder)
  - precio: número (punto o coma decimal)
  - moneda: ISO (ARS, USD, EUR...)
  - stock: en_stock | bajo | sin_stock | bajo_pedido (opcional)

  CÓMO PUBLICAR CSV (Opción A)
  ----------------------------
  1) Archivo → Publicar en la Web → elige la hoja a publicar (tu caso: "Sheet2") → CSV.
  2) Copia la URL; aquí ya está configurada con tu enlace y `gid=128232950`.
     Puedes cambiarla en CONFIG.SHEET_CSV_URL si publicas otra hoja.

  API JSON CON APPS SCRIPT (Opción B, recomendado)
  ------------------------------------------------
  1) Extensiones → Apps Script.
  2) Copia/pega el bloque "APPS SCRIPT — Opción B" que está al final de ESTE archivo (comentado).
  3) Implementar → Nueva implementación → Tipo: Aplicación web → Acceso: Cualquiera con el enlace.
  4) Pega la URL /exec en CONFIG.SHEET_JSON_URL (abajo).

  FLUJO DE DATOS Y FALLBACKS
  --------------------------
  - Intento en orden: JSON (Apps Script) → CSV publicado → dataset de ejemplo.
  - Cache en localStorage ("impresorasCache:v1") por 6 horas.

  SUGERENCIAS DE COMPRA (si la hoja no trae texto)
  ------------------------------------------------
  - stock == "bajo"        → "Comprar pronto: stock limitado"
  - stock == "sin_stock"   → "Esperar reposición"
  - precio < mediana(marca+tipo) → "Buen momento para comprar"
  - uso_recomendado == "estudiante" y estamos en TEMPORADA_CLASES
                           → "Comprar antes de inicio de clases"
  - Si nada aplica         → "Comprar según necesidad"
  La "fuente" de la sugerencia se muestra como texto pequeño/título.

  PRUEBAS MANUALES
  ----------------
  1) Abre `index.html` en el navegador.
  2) Verifica carga desde tu CSV (status arriba).
  3) Cambia filtros/selector para ver otra impresora.
  4) Añade 1–3 impresoras a la comparación y revisa la tabla.
  5) Forza offline para ver el dataset de ejemplo.
  6) Limpia cache: localStorage.removeItem('impresorasCache:v1') y recarga.

  NOTAS Y SUPUESTOS
  -----------------
  - Vanilla JS puro, sin frameworks.
  - Columnas `tipo` y `uso_recomendado` se asumen presentes (recomendado).
  - Moneda: se respeta la que llegue en `moneda`.
  - Carrusel: solo manual (teclas ←/→, botones Prev/Sig).
  - Máx. imágenes por impresora: 6 (configurable).
  - Vista por defecto: muestra la PRIMERA impresora tras aplicar filtros/orden.
  - La comparación incluye SIEMPRE la impresora seleccionada + las que agregues (hasta 4 en total).

  =============================================================================
  -->
  <style>
    :root{
      --gap: .75rem;
      --radius: .5rem;
      --border: 1px solid #e0e0e0;
      --shadow: 0 1px 2px rgba(0,0,0,.06);
      --focus: 2px solid #1a73e8;
      --muted: #6b7280;
      --badge-bg: #f3f4f6;
      --table-bg: #fafafa;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans";
      line-height: 1.4;
      color: #111;
      background: #fff;
    }
    header, footer {
      padding: 1rem;
      border-bottom: var(--border);
      background: #fafafa;
    }
    footer { border-top: var(--border); border-bottom: none; color: var(--muted); font-size: .9rem; }
    h1 { margin: 0 0 .5rem 0; font-size: 1.2rem; }
    .controls {
      display: grid;
      grid-template-columns: 1fr minmax(150px, 1fr) minmax(150px, 1fr) minmax(160px, 1fr) minmax(200px, 1.3fr) auto;
      gap: var(--gap);
      align-items: center;
    }
    .controls .meta { grid-column: 1 / -1; font-size: .9rem; color: var(--muted); }
    .controls input[type="search"],
    .controls select {
      width: 100%;
      padding: .55rem .6rem;
      border: var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      background: #fff;
    }
    .btn {
      display: inline-flex; align-items: center; justify-content: center;
      padding: .55rem .75rem;
      border: var(--border);
      border-radius: var(--radius);
      background: #fff;
      text-decoration: none;
      color: #111;
      font-weight: 500;
      cursor: pointer;
      box-shadow: var(--shadow);
    }
    .btn:focus-visible { outline: var(--focus); }
    .btn[disabled]{ opacity: .5; cursor: not-allowed; }

    main { padding: 1rem; display: grid; gap: 1rem; }
    .section-title { margin: 0; font-size: 1.05rem; }

    /* Card / Vista unitaria */
    .card {
      display: grid;
      grid-template-columns: minmax(280px, 1fr) 2fr;
      gap: 1rem;
      border: var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      background: #fff;
      overflow: hidden;
      padding: .75rem;
    }
    @media (max-width: 900px){
      .card { grid-template-columns: 1fr; }
    }
    .carousel {
      position: relative;
      background: #f6f7f9;
      min-height: 240px;
      display: grid;
      place-items: center;
      border-radius: .35rem;
      overflow: hidden;
      border: var(--border);
    }
    .carousel img, .carousel .placeholder {
      width: 100%; height: 100%; object-fit: cover; display: block;
    }
    .carousel .controls {
      position: absolute; inset: auto 0 .25rem 0; display: flex; gap: .5rem; justify-content: center;
    }
    .carousel .nav {
      position: absolute; top: 50%; transform: translateY(-50%);
      background: rgba(255,255,255,.9);
      border: var(--border);
      border-radius: var(--radius);
      padding: .25rem .4rem;
    }
    .carousel .prev { left: .25rem; }
    .carousel .next { right: .25rem; }
    .carousel .indicator {
      font-size: .8rem; padding: .15rem .5rem; border-radius: 999px; background: rgba(255,255,255,.9);
      border: var(--border); box-shadow: var(--shadow);
    }
    .content { display: grid; gap: .5rem; }
    .title { margin: 0; font-size: 1.1rem; line-height: 1.2; }
    .desc { margin: 0; color: var(--muted); font-size: .95rem; }
    .tags { display: flex; flex-wrap: wrap; gap: .35rem; }
    .tag {
      display: inline-flex; align-items: center; gap: .25rem;
      padding: .15rem .45rem; border-radius: 999px; background: var(--badge-bg);
      color: #374151; font-size: .8rem;
      border: var(--border);
    }
    .features { margin: 0; padding-left: 1.1rem; }
    .features li { margin: .15rem 0; font-size: .92rem; }
    .price { font-weight: 600; font-size: 1rem; }
    .suggestion {
      display: flex; align-items: baseline; gap: .5rem; flex-wrap: wrap;
      padding: .4rem .5rem;
      border-radius: .35rem;
      background: #f9fafb;
      border: var(--border);
      font-size: .9rem;
    }
    .suggestion small { color: var(--muted); font-size: .8rem; }
    .actions { display: flex; gap: .5rem; flex-wrap: wrap; }
    .status {
      padding: .5rem .75rem; border-radius: .35rem; border: var(--border); background: #fff; box-shadow: var(--shadow);
      margin: .5rem 0 0 0; color: #374151; font-size: .92rem;
    }
    .hidden { display: none !important; }
    :focus-visible { outline: var(--focus); outline-offset: 2px; }

    /* Comparador */
    .compare-controls {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: .5rem;
      align-items: center;
    }
    .compare-wrap {
      overflow-x: auto;
      border: var(--border);
      border-radius: var(--radius);
      background: #fff;
    }
    table.compare {
      border-collapse: separate;
      border-spacing: 0;
      width: 100%;
      min-width: 760px;
    }
    .compare th, .compare td {
      border-bottom: var(--border);
      padding: .5rem .6rem;
      vertical-align: top;
      background: #fff;
    }
    .compare thead th {
      position: sticky; top: 0; background: var(--table-bg);
      z-index: 1;
    }
    .compare tbody tr:nth-child(even) td { background: #fcfcfc; }
    .compare th.sticky, .compare td.sticky {
      position: sticky; left: 0; background: var(--table-bg); z-index: 2; border-right: var(--border);
      min-width: 180px;
    }
    .compare .col-actions { white-space: nowrap; }
    .muted { color: var(--muted); font-size: .9rem; }
    .chip { display:inline-block; padding:.1rem .35rem; border:var(--border); border-radius:999px; background:#f5f5f5; font-size:.78rem; }
    .small-btn { font-size:.8rem; padding:.25rem .5rem; }
    .sr-only {
      position: absolute!important; width: 1px!important; height: 1px!important; padding: 0!important; margin: -1px!important;
      overflow: hidden!important; clip: rect(0,0,0,0)!important; white-space: nowrap!important; border: 0!important;
    }

    @media (max-width: 900px){
      .controls {
        grid-template-columns: 1fr 1fr;
      }
      .controls .btn { grid-column: span 2; }
      .controls .meta { grid-column: 1 / -1; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Impresoras — Vista Unitaria + Comparador</h1>
    <div class="controls" role="region" aria-label="Controles de filtrado, selección y orden">
      <input id="searchInput" type="search" placeholder="Buscar por marca, modelo o características…" aria-label="Buscar impresoras" />
      <select id="brandFilter" aria-label="Filtrar por marca">
        <option value="">Todas las marcas</option>
      </select>
      <select id="typeFilter" aria-label="Filtrar por tipo">
        <option value="">Todos los tipos</option>
      </select>
      <select id="sortSelect" aria-label="Ordenar">
        <option value="name_asc">Nombre A-Z</option>
        <option value="price_asc">Precio ↑</option>
        <option value="price_desc">Precio ↓</option>
      </select>
      <select id="printerSelect" aria-label="Seleccionar impresora para ver">
        <option value="">Seleccionar impresora…</option>
      </select>
      <button id="clearBtn" class="btn" type="button" title="Limpiar búsqueda, filtros y selección">Limpiar</button>

      <div id="status" class="status meta" role="status" aria-live="polite">Cargando datos…</div>
    </div>
  </header>

  <main>
    <section aria-label="Vista de impresora seleccionada">
      <h2 class="section-title">Impresora seleccionada</h2>
      <div id="primaryContainer"></div>
    </section>

    <section aria-label="Comparador de impresoras">
      <h2 class="section-title">Comparar impresoras</h2>
      <div class="compare-controls" role="region" aria-label="Controles para comparación">
        <select id="compareSelect" multiple size="4" aria-label="Selecciona 1–3 impresoras para comparar (además de la seleccionada)">
          <!-- opciones dinámicas -->
        </select>
        <button id="addToCompareBtn" class="btn small-btn" type="button" title="Añadir seleccionadas a la comparación">Añadir a comparación</button>
        <button id="clearCompareBtn" class="btn small-btn" type="button" title="Vaciar comparación">Vaciar comparación</button>
      </div>
      <div class="muted">La primera columna es la característica. Las columnas siguientes son las impresoras comparadas (incluye siempre la seleccionada).</div>
      <div id="compareWrap" class="compare-wrap" aria-live="polite"></div>
    </section>
  </main>

  <template id="tpl-card">
    <article class="card">
      <div class="carousel" tabindex="0" aria-label="Galería de imágenes" aria-live="polite">
        <button class="btn nav prev" type="button" aria-label="Imagen anterior">◀</button>
        <img class="slide" loading="lazy" decoding="async" alt="" />
        <div class="controls">
          <span class="indicator" aria-live="polite" aria-atomic="true">1/1</span>
        </div>
        <button class="btn nav next" type="button" aria-label="Imagen siguiente">▶</button>
      </div>

      <div class="content">
        <h3 class="title"><span class="name"></span></h3>
        <p class="desc"></p>
        <div class="tags">
          <span class="tag brand" title="Marca"></span>
          <span class="tag type" title="Tipo"></span>
          <span class="tag stock" title="Estado de stock"></span>
        </div>
        <ul class="features"></ul>
        <div class="price"></div>
        <div class="suggestion">
          <span class="suggestion-text"></span>
          <small class="suggestion-source"></small>
        </div>
        <div class="actions">
          <a class="btn link" target="_blank" rel="noopener">Ver en mi sitio</a>
          <button class="btn small-btn add-to-compare" type="button" title="Añadir esta impresora a la comparación">Añadir a comparación</button>
        </div>
        <small class="muted">Última actualización: <span class="updated"></span></small>
      </div>
    </article>
  </template>

  <footer>
    <small>Prototipo base — HTML y JS puros. Estilos mínimos y utilitarios para fácil personalización.</small>
  </footer>

  <script>
    // =========================================================================
    // CONFIGURACIÓN
    // =========================================================================
    const CONFIG = {
      SHEET_JSON_URL: "https://script.google.com/.../exec", // PLACEHOLDER (Apps Script Web App - Opción B)
      // CSV publicado — tu enlace a "Sheet2" (gid=128232950):
      SHEET_CSV_URL: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTZ-GFIahnmzB09C1GWCvAs1PaNXmpN2_Ed5taWtseTRlqx0P8-ZKJ28TOsvziFOw/pub?gid=128232950&single=true&output=csv",
      TEMPORADA_CLASES: { inicio: "2025-02-15", fin: "2025-03-31" },
      CACHE_TTL_MS: 1000 * 60 * 60 * 6, // 6 horas
    };
    const CACHE_KEY = "impresorasCache:v1";
    const MAX_IMAGES_PER_CARD = 6;
    const MAX_COMPARE_TOTAL = 4; // Incluye la seleccionada. Ej: seleccionada + 3 más.

    // =========================================================================
    // DATASET DE EJEMPLO (fallback)
    // =========================================================================
    const SAMPLE_DATA = [
      {
        id: "hp-415",
        marca: "HP",
        modelo: "Ink Tank 415",
        nombre: "",
        tipo: "inyeccion",
        descripcion_corta: "Multifunción con Wi-Fi para hogar y tareas escolares.",
        caracteristicas: "Wi-Fi|Imprime/Escanea/Copia|A4|Tanque de tinta",
        imagenes: "",
        precio: "149999",
        moneda: "ARS",
        url_producto: "https://tu-dominio.example/impresoras/hp-ink-tank-415",
        stock: "bajo",
        uso_recomendado: "estudiante",
        sugerencia_compra: "",
        ultima_actualizacion: "2025-08-01",
      },
      {
        id: "epson-l3250",
        marca: "Epson",
        modelo: "L3250",
        nombre: "Epson EcoTank L3250",
        tipo: "multifunción",
        descripcion_corta: "EcoTank con impresión económica y conectividad móvil.",
        caracteristicas: "EcoTank|Wi-Fi|Imprime/Escanea/Copia|A4",
        imagenes: "",
        precio: "189999",
        moneda: "ARS",
        url_producto: "https://tu-dominio.example/impresoras/epson-l3250",
        stock: "en_stock",
        uso_recomendado: "hogar",
        sugerencia_compra: "",
        ultima_actualizacion: "2025-07-20",
      },
      {
        id: "brother-hl-l2370dw",
        marca: "Brother",
        modelo: "HL-L2370DW",
        nombre: "",
        tipo: "láser",
        descripcion_corta: "Láser monocromática rápida con dúplex y Wi-Fi.",
        caracteristicas: "Láser|Dúplex|Wi-Fi|A4|Monocromo",
        imagenes: "",
        precio: "214999",
        moneda: "ARS",
        url_producto: "https://tu-dominio.example/impresoras/brother-hl-l2370dw",
        stock: "sin_stock",
        uso_recomendado: "oficina",
        sugerencia_compra: "",
        ultima_actualizacion: "2025-08-05",
      },
    ];

    // =========================================================================
    // ESTADO GLOBAL
    // =========================================================================
    const state = {
      raw: [],
      items: [],           // transformados/normalizados
      medianaPorGrupo: {}, // { "marca|tipo": numero }
      filters: {
        search: "",
        marca: "",
        tipo: "",
        sort: "name_asc",
      },
      selectedId: "",      // impresora principal
      compareIds: [],      // ids adicionales para comparar (excluye selectedId)
    };

    // =========================================================================
    // UTILIDADES
    // =========================================================================
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    function debounce(fn, delay=300) {
      let t;
      return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), delay); };
    }

    function withinDateRange(_d, range) {
      const today = new Date();
      const start = new Date(range.inicio + "T00:00:00");
      const end   = new Date(range.fin    + "T23:59:59");
      return today >= start && today <= end;
    }

    function parsePrice(value) {
      if (value == null || value === "") return null;
      const s = String(value).trim().replace(/\s+/g, "");
      const normalized = s
        .replace(/(?<=\d)[.,](?=\d{3}\b)/g, "") // quita separador de miles
        .replace(",", "."); // usa punto decimal
      const n = Number(normalized);
      return Number.isFinite(n) ? n : null;
    }

    function formatPrice(n, currency) {
      if (n == null) return "";
      try {
        if (currency) {
          return new Intl.NumberFormat(undefined, { style: "currency", currency }).format(n);
        }
      } catch(_) {}
      return new Intl.NumberFormat(undefined).format(n) + (currency ? ` ${currency}` : "");
    }

    // CSV parser (maneja comillas dobles)
    function parseCSVToObjects(csvText) {
      const rows = [];
      let i=0, field="", row=[], inQuotes=false;
      function endField(){ row.push(field); field=""; }
      function endRow(){ rows.push(row); row=[]; }
      while (i < csvText.length) {
        const c = csvText[i];
        if (inQuotes) {
          if (c === '"') {
            if (csvText[i+1] === '"') { field += '"'; i++; } else { inQuotes = false; }
          } else { field += c; }
        } else {
          if (c === '"') inQuotes = true;
          else if (c === ",") endField();
          else if (c === "\n") { endField(); endRow(); }
          else if (c === "\r") { /* ignore */ }
          else field += c;
        }
        i++;
      }
      endField(); endRow();
      const headers = rows.shift()?.map(h => (h || "").trim()) || [];
      return rows
        .filter(r => r.some(v => (v||"").trim() !== ""))
        .map(r => {
          const obj = {};
          headers.forEach((h, idx) => obj[h] = (r[idx] ?? "").trim());
          return obj;
        });
    }

    function initials(strA, strB="") {
      const s = [strA, strB].filter(Boolean).join(" ");
      const parts = s.split(/\s+/).filter(Boolean);
      const ini = parts.slice(0,2).map(x => x[0].toUpperCase()).join("");
      return ini || "PR";
    }

    function placeholderDataURI(text="PR") {
      const svg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="1200" height="800">
          <rect width="100%" height="100%" fill="#e5e7eb"/>
          <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"
            font-family="system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Helvetica, Arial"
            font-size="160" fill="#6b7280" font-weight="700">${text}</text>
        </svg>`;
      return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
    }

    // =========================================================================
    // FETCH + CACHE (JSON → CSV → SAMPLE)
    // =========================================================================
    async function tryFetchJSON(url) {
      if (!url || url.includes(".../exec")) throw new Error("JSON URL placeholder");
      const res = await fetch(url, { headers: { "Accept": "application/json" }});
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      const rows = Array.isArray(data) ? data : (Array.isArray(data.data) ? data.data : []);
      if (!rows.length) throw new Error("JSON vacío");
      return rows;
    }

    async function tryFetchCSV(url) {
      if (!url) throw new Error("CSV URL vacío");
      const res = await fetch(url, { headers: { "Accept": "text/csv" }});
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const text = await res.text();
      const rows = parseCSVToObjects(text);
      if (!rows.length) throw new Error("CSV vacío");
      return rows;
    }

    function saveCache(items) {
      const payload = { ts: Date.now(), items };
      try { localStorage.setItem(CACHE_KEY, JSON.stringify(payload)); } catch(_) {}
    }

    function loadCache() {
      try {
        const raw = localStorage.getItem(CACHE_KEY);
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        if (!parsed || !Array.isArray(parsed.items)) return null;
        if (Date.now() - parsed.ts > CONFIG.CACHE_TTL_MS) return null;
        return parsed.items;
      } catch(_) { return null; }
    }

    async function loadDataWithFallback() {
      const status = $("#status");
      status.textContent = "Cargando datos…";

      const cached = loadCache();
      if (cached) {
        status.textContent = `Usando cache (${cached.length} registros)`;
        return cached;
      }

      try {
        status.textContent = "Consultando API JSON (Apps Script)…";
        const jsonRows = await tryFetchJSON(CONFIG.SHEET_JSON_URL);
        status.textContent = `Datos recibidos de API JSON (${jsonRows.length})`;
        saveCache(jsonRows);
        return jsonRows;
      } catch (e) {
        status.textContent = `Fallo API JSON. Probando CSV… (${e.message})`;
      }
      try {
        status.textContent = "Consultando CSV publicado…";
        const csvRows = await tryFetchCSV(CONFIG.SHEET_CSV_URL);
        status.textContent = `Datos recibidos de CSV (${csvRows.length})`;
        saveCache(csvRows);
        return csvRows;
      } catch (e) {
        status.textContent = `Fallo CSV. Usando dataset de ejemplo. (${e.message})`;
      }
      return SAMPLE_DATA;
    }

    // =========================================================================
    // TRANSFORMACIÓN DE DATOS
    // =========================================================================
    function normalizeRow(row) {
      const item = { ...row };
      const marca = (item.marca || "").trim();
      const modelo = (item.modelo || "").trim();
      item.nombre = (item.nombre || "").trim() || `${marca} ${modelo}`.trim();
      item.marca = marca;
      item.modelo = modelo;
      item.tipo = (item.tipo || "").trim();
      item.descripcion_corta = (item.descripcion_corta || "").trim();

      const features = (item.caracteristicas || "")
        .split("|").map(x => x.trim()).filter(Boolean);
      item._features = features;

      let images = (item.imagenes || "")
        .split(",").map(x => x.trim()).filter(Boolean);
      if (images.length > MAX_IMAGES_PER_CARD) images = images.slice(0, MAX_IMAGES_PER_CARD);
      if (!images.length) images = [placeholderDataURI(initials(item.marca, item.modelo))];
      item._images = images;

      const precioNum = parsePrice(item.precio);
      item._precio = precioNum;
      item.moneda = (item.moneda || "").trim().toUpperCase();
      item.url_producto = (item.url_producto || "").trim();
      item.stock = (item.stock || "").trim();
      item.uso_recomendado = (item.uso_recomendado || "").trim();
      item.sugerencia_compra = (item.sugerencia_compra || "").trim();
      item.ultima_actualizacion = (item.ultima_actualizacion || "").trim();
      item.id = (item.id || `${item.marca}-${item.modelo}`).trim();

      return item;
    }

    function computeMedian(numbers) {
      if (!numbers.length) return null;
      const arr = numbers.slice().sort((a,b)=>a-b);
      const mid = Math.floor(arr.length/2);
      return (arr.length % 2) ? arr[mid] : (arr[mid-1] + arr[mid]) / 2;
    }

    function buildMedians(items) {
      const groups = new Map();
      for (const it of items) {
        if (it._precio == null) continue;
        const key = `${it.marca}|${it.tipo}`;
        if (!groups.has(key)) groups.set(key, []);
        groups.get(key).push(it._precio);
      }
      const med = {};
      for (const [key, nums] of groups.entries()) med[key] = computeMedian(nums);
      return med;
    }

    function computeSuggestion(item, medianas, temporada) {
      if (item.sugerencia_compra) {
        return { text: item.sugerencia_compra, source: "Fuente: hoja de cálculo" };
      }
      if (item.stock === "bajo")       return { text: "Comprar pronto: stock limitado", source: "Regla: stock=bajo" };
      if (item.stock === "sin_stock")  return { text: "Esperar reposición", source: "Regla: stock=sin_stock" };
      const key = `${item.marca}|${item.tipo}`;
      const med = medianas[key];
      if (item._precio != null && med != null && item._precio < med) {
        return { text: "Buen momento para comprar", source: "Regla: precio < mediana(marca+tipo)" };
      }
      if (item.uso_recomendado === "estudiante" && withinDateRange(new Date(), temporada)) {
        return { text: "Comprar antes de inicio de clases", source: "Regla: temporada estudiantes" };
      }
      return { text: "Comprar según necesidad", source: "Regla: sin condición específica" };
    }

    function transformAll(rows) {
      const items = rows.map(normalizeRow);
      const medians = buildMedians(items);
      for (const it of items) {
        const sug = computeSuggestion(it, medians, CONFIG.TEMPORADA_CLASES);
        it._sugerencia = sug.text;
        it._sugerencia_source = sug.source;
      }
      return { items, medians };
    }

    // =========================================================================
    // RENDER: Selectores, Vista unitaria, Comparador
    // =========================================================================
    function buildFilters(items) {
      const brandSel = $("#brandFilter");
      const typeSel  = $("#typeFilter");
      brandSel.length = 1;
      typeSel.length  = 1;

      const brands = Array.from(new Set(items.map(i => i.marca).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
      const types  = Array.from(new Set(items.map(i => i.tipo).filter(Boolean))).sort((a,b)=>a.localeCompare(b));

      for (const b of brands) {
        const opt = document.createElement("option");
        opt.value = b; opt.textContent = b;
        brandSel.appendChild(opt);
      }
      for (const t of types) {
        const opt = document.createElement("option");
        opt.value = t; opt.textContent = t;
        typeSel.appendChild(opt);
      }
    }

    function filteredItems() {
      const q = state.filters.search.toLowerCase().trim();
      const marca = state.filters.marca;
      const tipo = state.filters.tipo;

      let out = state.items.filter(it => {
        if (marca && it.marca !== marca) return false;
        if (tipo && it.tipo !== tipo) return false;
        if (q) {
          const haystack = [
            it.marca, it.modelo, it.nombre, it.tipo,
            it.descripcion_corta, it._features.join(" ")
          ].join(" ").toLowerCase();
          if (!haystack.includes(q)) return false;
        }
        return true;
      });

      const sort = state.filters.sort;
      if (sort === "name_asc") {
        out.sort((a,b)=> a.nombre.localeCompare(b.nombre, undefined, { sensitivity:"base" }));
      } else if (sort === "price_asc") {
        out.sort((a,b)=> (a._precio ?? Infinity) - (b._precio ?? Infinity));
      } else if (sort === "price_desc") {
        out.sort((a,b)=> (b._precio ?? -Infinity) - (a._precio ?? -Infinity));
      }
      return out;
    }

    function populateSelectors() {
      const items = filteredItems();
      const printerSel = $("#printerSelect");
      const compareSel = $("#compareSelect");

      // Repoblar selector de impresora
      const current = printerSel.value;
      printerSel.innerHTML = '<option value="">Seleccionar impresora…</option>';
      for (const it of items) {
        const opt = document.createElement("option");
        opt.value = it.id;
        opt.textContent = it.nombre || `${it.marca} ${it.modelo}`;
        printerSel.appendChild(opt);
      }
      // Mantener selección si sigue disponible; si no, elegir primera
      if (items.find(x => x.id === current)) {
        printerSel.value = current;
        state.selectedId = current;
      } else {
        const first = items[0]?.id || "";
        printerSel.value = first;
        state.selectedId = first;
      }

      // Repoblar selector múltiple de comparación (excluye la seleccionada)
      const selectedId = state.selectedId;
      const compareCandidates = items.filter(x => x.id !== selectedId);
      const prevSelected = new Set(Array.from(compareSel.selectedOptions).map(o => o.value));
      compareSel.innerHTML = "";
      for (const it of compareCandidates) {
        const opt = document.createElement("option");
        opt.value = it.id;
        opt.textContent = it.nombre;
        if (prevSelected.has(it.id)) opt.selected = true;
        compareSel.appendChild(opt);
      }

      setStatus(`Catálogo: ${items.length} disponibles — Seleccionada: ${state.selectedId || "ninguna"}`);
    }

    function renderPrimary() {
      const container = $("#primaryContainer");
      container.innerHTML = "";
      const item = state.items.find(x => x.id === state.selectedId);
      if (!item) {
        const msg = document.createElement("div");
        msg.className = "status";
        msg.textContent = "No hay impresoras que coincidan con los filtros o no hay selección.";
        container.appendChild(msg);
        return;
      }
      const node = renderCard(item);
      // botón "Añadir a comparación" en la card
      $(".add-to-compare", node).addEventListener("click", () => {
        addToCompare([item.id]);
      });
      container.appendChild(node);
    }

    function renderCard(item) {
      const tpl = $("#tpl-card");
      const el = tpl.content.firstElementChild.cloneNode(true);

      // Carrusel
      const carouselEl = $(".carousel", el);
      carouselEl.setAttribute("aria-label", `Galería de ${item.nombre}`);
      const imgEl = $(".slide", el);
      const indicatorEl = $(".indicator", el);
      const prevBtn = $(".prev", el);
      const nextBtn = $(".next", el);
      const images = item._images.slice(0, MAX_IMAGES_PER_CARD);
      let idx = 0;
      function updateSlide() {
        const src = images[idx];
        imgEl.src = src;
        imgEl.alt = `Foto ${idx+1} de ${images.length} — ${item.nombre}`;
        indicatorEl.textContent = `${idx+1}/${images.length}`;
      }
      function goPrev() { idx = (idx - 1 + images.length) % images.length; updateSlide(); }
      function goNext() { idx = (idx + 1) % images.length; updateSlide(); }
      prevBtn.addEventListener("click", goPrev);
      nextBtn.addEventListener("click", goNext);
      carouselEl.addEventListener("keydown", (e) => {
        if (e.key === "ArrowLeft") { e.preventDefault(); goPrev(); }
        if (e.key === "ArrowRight") { e.preventDefault(); goNext(); }
      });
      updateSlide();

      // Contenido
      $(".name", el).textContent = item.nombre;
      $(".desc", el).textContent = item.descripcion_corta || "";
      $(".brand", el).textContent = item.marca || "—";
      $(".type", el).textContent = item.tipo || "—";

      const stockMap = { en_stock: "En stock", bajo: "Stock bajo", sin_stock: "Sin stock", bajo_pedido: "Bajo pedido" };
      const stockText = stockMap[item.stock] || (item.stock ? item.stock : "—");
      const stockTag = $(".stock", el);
      stockTag.textContent = stockText;
      stockTag.dataset.stock = item.stock || "";

      const feats = $(".features", el);
      feats.innerHTML = "";
      for (const f of item._features) {
        const li = document.createElement("li");
        li.textContent = f;
        feats.appendChild(li);
      }
      if (!item._features.length) feats.classList.add("hidden");

      const priceEl = $(".price", el);
      if (item._precio != null) priceEl.textContent = formatPrice(item._precio, item.moneda);

      const sugEl = $(".suggestion", el);
      $(".suggestion-text", sugEl).textContent = item._sugerencia;
      $(".suggestion-source", sugEl).textContent = item._sugerencia_source;
      sugEl.title = item._sugerencia_source;

      const linkEl = $(".link", el);
      if (item.url_producto) {
        linkEl.href = item.url_producto;
      } else {
        linkEl.href = "javascript:void(0)";
        linkEl.setAttribute("aria-disabled", "true");
        linkEl.classList.add("disabled");
        linkEl.textContent = "Sin enlace";
        linkEl.addEventListener("click", e => e.preventDefault());
      }

      $(".updated", el).textContent = item.ultima_actualizacion || "—";

      return el;
    }

    function addToCompare(ids) {
      const filtered = filteredItems().map(x => x.id);
      const validIds = ids.filter(id => id && id !== state.selectedId && filtered.includes(id));
      for (const id of validIds) {
        if (!state.compareIds.includes(id)) state.compareIds.push(id);
      }
      // limitar total (incluyendo la seleccionada)
      const allowedExtras = Math.max(0, MAX_COMPARE_TOTAL - 1);
      state.compareIds = state.compareIds.slice(0, allowedExtras);
      renderCompare();
    }

    function removeFromCompare(id) {
      state.compareIds = state.compareIds.filter(x => x !== id);
      renderCompare();
    }

    function renderCompare() {
      const wrap = $("#compareWrap");
      wrap.innerHTML = "";

      const primary = state.items.find(x => x.id === state.selectedId);
      if (!primary) {
        const msg = document.createElement("div");
        msg.className = "status";
        msg.textContent = "Selecciona primero una impresora para comparar.";
        wrap.appendChild(msg);
        return;
      }

      const selectedCompare = state.compareIds
        .map(id => state.items.find(x => x.id === id))
        .filter(Boolean);

      const items = [primary, ...selectedCompare];
      const table = buildCompareTable(items);
      wrap.appendChild(table);
    }

    function buildCompareTable(items) {
      // Unión de características
      const featureSet = new Set();
      items.forEach(it => it._features.forEach(f => featureSet.add(f)));
      const featureList = Array.from(featureSet).sort((a,b)=>a.localeCompare(b));

      const fields = [
        { key: "_name", label: "Nombre" },
        { key: "marca", label: "Marca" },
        { key: "modelo", label: "Modelo" },
        { key: "tipo", label: "Tipo" },
        { key: "_precioFmt", label: "Precio" },
        { key: "moneda", label: "Moneda" },
        { key: "stock", label: "Stock" },
        { key: "uso_recomendado", label: "Uso recomendado" },
        { key: "_sugerencia", label: "Sugerencia de compra" },
        { key: "ultima_actualizacion", label: "Última actualización" },
      ];

      const t = document.createElement("table");
      t.className = "compare";
      t.setAttribute("role","table");
      const thead = t.createTHead();
      const hrow = thead.insertRow();

      // Header primera celda (fija)
      const h0 = document.createElement("th");
      h0.textContent = "Especificación";
      h0.className = "sticky";
      hrow.appendChild(h0);

      // Columnas por impresora
      for (const it of items) {
        const th = document.createElement("th");
        th.innerHTML = `
          <div><strong>${it.nombre}</strong></div>
          <div class="muted">${it.marca} ${it.modelo}</div>
          <div class="col-actions">
            ${it.url_producto ? `<a class="btn small-btn" href="${it.url_producto}" target="_blank" rel="noopener">Ver en mi sitio</a>` : `<span class="chip">Sin enlace</span>`}
            ${it.id !== state.selectedId ? `<button class="btn small-btn remove-col" data-id="${it.id}" type="button" title="Quitar de la comparación">Quitar</button>` : `<span class="chip">Seleccionada</span>`}
          </div>
        `;
        hrow.appendChild(th);
      }

      const tbody = t.createTBody();

      function addRow(label, getter) {
        const tr = tbody.insertRow();
        const th = document.createElement("th");
        th.textContent = label;
        th.className = "sticky";
        tr.appendChild(th);
        for (const it of items) {
          const td = tr.insertCell();
          td.innerHTML = getter(it) ?? "—";
        }
      }

      // Prepara valores formateados
      items.forEach(it => {
        it._name = it.nombre;
        it._precioFmt = it._precio != null ? formatPrice(it._precio, it.moneda) : "—";
      });

      // Filas básicas
      for (const f of fields) {
        addRow(f.label, (it) => escapeHTML(String(it[f.key] ?? "")));
      }

      // Descripción corta (opcional)
      addRow("Descripción", (it) => it.descripcion_corta ? escapeHTML(it.descripcion_corta) : "—");

      // Características (unión)
      for (const feat of featureList) {
        addRow(`Caract.: ${feat}`, (it) => it._features.includes(feat) ? "✓" : "—");
      }

      // Eventos quitar
      $$(".remove-col", t).forEach(btn => {
        btn.addEventListener("click", (e) => {
          const id = e.currentTarget.dataset.id;
          removeFromCompare(id);
        });
      });

      return t;
    }

    function escapeHTML(s) {
      return s
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    function setStatus(text) {
      const status = $("#status");
      status.textContent = text;
    }

    // =========================================================================
    // EVENTOS
    // =========================================================================
    function attachEvents() {
      $("#searchInput").addEventListener("input", debounce((e) => {
        state.filters.search = e.target.value;
        updateUI();
      }, 300));
      $("#brandFilter").addEventListener("change", (e) => { state.filters.marca = e.target.value; updateUI(); });
      $("#typeFilter").addEventListener("change",  (e) => { state.filters.tipo  = e.target.value; updateUI(); });
      $("#sortSelect").addEventListener("change",  (e) => { state.filters.sort  = e.target.value; updateUI(); });

      $("#printerSelect").addEventListener("change", (e) => {
        state.selectedId = e.target.value || "";
        renderPrimary();
        renderCompare(); // actualiza "seleccionada" en tabla
        refreshCompareCandidates(); // evita que la seleccionada aparezca como candidata
      });

      $("#clearBtn").addEventListener("click", () => {
        state.filters = { search: "", marca: "", tipo: "", sort: "name_asc" };
        $("#searchInput").value = "";
        $("#brandFilter").value = "";
        $("#typeFilter").value = "";
        $("#sortSelect").value = "name_asc";
        state.selectedId = "";
        state.compareIds = [];
        updateUI();
      });

      $("#addToCompareBtn").addEventListener("click", () => {
        const sel = $("#compareSelect");
        const ids = Array.from(sel.selectedOptions).map(o => o.value);
        addToCompare(ids);
      });

      $("#clearCompareBtn").addEventListener("click", () => {
        state.compareIds = [];
        renderCompare();
      });
    }

    function refreshCompareCandidates() {
      // Mantener selección múltiple lo más posible, pero excluyendo la seleccionada
      const compareSel = $("#compareSelect");
      const prev = new Set(Array.from(compareSel.selectedOptions).map(o => o.value));
      const items = filteredItems().filter(x => x.id !== state.selectedId);
      compareSel.innerHTML = "";
      for (const it of items) {
        const opt = document.createElement("option");
        opt.value = it.id;
        opt.textContent = it.nombre;
        if (prev.has(it.id)) opt.selected = true;
        compareSel.appendChild(opt);
      }
    }

    function updateUI() {
      populateSelectors();
      renderPrimary();
      // depurar compareIds si ya no están en el set filtrado
      const allowed = new Set(filteredItems().map(x => x.id));
      state.compareIds = state.compareIds.filter(id => allowed.has(id) && id !== state.selectedId);
      refreshCompareCandidates();
      renderCompare();
    }

    // =========================================================================
    // INIT
    // =========================================================================
    (async function init(){
      try {
        const rows = await loadDataWithFallback();
        state.raw = rows;
        const { items, medians } = transformAll(rows);
        state.items = items;
        state.medianaPorGrupo = medians;
        buildFilters(items);
        attachEvents();
        updateUI();
      } catch (err) {
        console.error(err);
        setStatus("Error al cargar datos. Intenta recargar la página.");
        const container = $("#primaryContainer");
        const msg = document.createElement("div");
        msg.className = "status";
        msg.textContent = "Ocurrió un error inesperado al obtener los datos.";
        container.appendChild(msg);
      }
    })();
  </script>

  <!--
  =============================================================================
  APPS SCRIPT — Opción B (copia este bloque en tu Apps Script y despliega como Web App)
  =============================================================================

  /**
   * Lee la pestaña (por defecto "Impresoras" o la que indiques por query) y expone JSON de solo lectura.
   * Despliegue: Implementar → Nueva implementación → Aplicación web
   *   - Ejecutar como: Tú
   *   - Quién tiene acceso: Cualquiera con el enlace
   *   - Copia la URL /exec en CONFIG.SHEET_JSON_URL
   *
   * Parámetros opcionales:
   *   - ?id=SPREADSHEET_ID    → ID del Google Sheet (si no es el actual)
   *   - ?sheet=Sheet2          → Nombre de la pestaña (ej: "Sheet2" en tu caso)
   */
  function doGet(e) {
    try {
      const ss = (e && e.parameter && e.parameter.id)
        ? SpreadsheetApp.openById(e.parameter.id)
        : SpreadsheetApp.getActiveSpreadsheet();
      const sheetName = (e && e.parameter && e.parameter.sheet) ? e.parameter.sheet : "Impresoras";
      const sh = ss.getSheetByName(sheetName);
      if (!sh) return jsonResponse({ error: "Sheet not found: " + sheetName, data: [] }, 404);

      const values = sh.getDataRange().getValues();
      if (!values || values.length < 2) return jsonResponse({ data: [], sheet: sheetName, count: 0 });

      const headers = values[0].map(String);
      const rows = [];
      for (let r = 1; r < values.length; r++) {
        const row = values[r];
        if (row.every(v => v === "" || v == null)) continue;
        const obj = {};
        headers.forEach((h, i) => obj[h] = row[i] == null ? "" : String(row[i]));
        rows.push(obj);
      }

      return jsonResponse({
        data: rows,
        updatedAt: new Date().toISOString(),
        sheet: sheetName,
        count: rows.length,
      });
    } catch (err) {
      return jsonResponse({ error: String(err), data: [] }, 500);
    }
  }

  function jsonResponse(obj, code) {
    const out = ContentService.createTextOutput(JSON.stringify(obj));
    out.setMimeType(ContentService.MimeType.JSON);
    return out;
  }

  =============================================================================
  FIN APPS SCRIPT
  =============================================================================
  -->
</body>
</html>
