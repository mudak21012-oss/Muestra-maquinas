<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Catálogo de Impresoras — Vista compacta + Comparador</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!--
  =============================================================================
  RESUMEN
  - Interfaz compacta y funcional:
      • Toolbar densa y pegajosa (sticky).
      • Lista rápida a la izquierda para seleccionar impresora (1 clic).
      • Atajos: "/" enfoca búsqueda · Alt+←/→ navega impresora anterior/siguiente · "c" abre/cierra comparador.
      • Vista unitaria condensada con "Más detalles".
      • Comparador plegable (details) con contador de columnas.
  - Sin frameworks. Un solo archivo. Sigue consumiendo tu CSV (gid=128232950).
  - Mantiene filtros, orden, sugerencias, cache y fallback.
  =============================================================================
  -->
  <style>
    :root{
      --gap:.5rem; --radius:.45rem; --border:1px solid #e5e7eb; --shadow:0 1px 2px rgba(0,0,0,.06);
      --focus:2px solid #1a73e8; --muted:#6b7280; --badge:#f3f4f6; --table:#fafafa;
      --sidebar-w: 300px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial; color:#111; }

    /* Toolbar compacta */
    header {
      position: sticky; top: 0; z-index: 5; background:#fff; border-bottom:var(--border);
      padding:.5rem .75rem;
    }
    .toolbar { display:grid; grid-template-columns: 1.2fr .9fr .9fr .9fr auto; gap:var(--gap); align-items:center; }
    h1 { font-size:1.05rem; margin:0 0 .4rem 0; }
    .toolbar input[type="search"], .toolbar select {
      width:100%; padding:.45rem .55rem; border:var(--border); border-radius:var(--radius); box-shadow:var(--shadow); background:#fff;
    }
    .btn { display:inline-flex; align-items:center; gap:.25rem; padding:.4rem .6rem; border:var(--border); border-radius:var(--radius); background:#fff; cursor:pointer; box-shadow:var(--shadow); }
    .btn:focus-visible { outline:var(--focus); }
    .link-btn { border:none; background:transparent; color:#2563eb; padding:.2rem .25rem; cursor:pointer; }
    .status { justify-self:end; font-size:.85rem; color:#374151; background:#fff; border:var(--border); border-radius:.35rem; padding:.25rem .5rem; box-shadow:var(--shadow); }

    /* Layout principal con lista rápida */
    .layout { display:grid; grid-template-columns: var(--sidebar-w) 1fr; gap:.75rem; padding:.75rem; }
    @media (max-width: 980px){ .layout { grid-template-columns: 1fr; } :root{ --sidebar-w: 100%; } }

    /* Lista rápida */
    .quick { border:var(--border); border-radius:var(--radius); background:#fff; box-shadow:var(--shadow); overflow:hidden; display:flex; flex-direction:column; min-height:240px; }
    .quick header { position:unset; border-bottom:var(--border); padding:.5rem .6rem; }
    .quick ul { list-style:none; margin:0; padding:0; overflow:auto; max-height:60vh; }
    .quick li { display:grid; grid-template-columns: 1fr auto; gap:.5rem; align-items:center; padding:.4rem .6rem; border-bottom:1px dashed #f0f0f0; }
    .quick li:last-child { border-bottom:none; }
    .quick .name { font-size:.93rem; line-height:1.2; }
    .quick .meta { color:var(--muted); font-size:.8rem; }
    .quick .row-actions { display:flex; gap:.35rem; }
    .quick .add { font-size:.8rem; }
    .quick .price { font-weight:600; font-size:.9rem; }
    .quick li[aria-current="true"] { background:#f8fafc; }
    .chip { display:inline-block; padding:.05rem .4rem; border-radius:999px; border:var(--border); background:#f8f8f8; font-size:.75rem; color:#374151; }

    /* Card compacta */
    .card {
      display:grid; grid-template-columns: minmax(260px, 1fr) 1.5fr; gap:.75rem;
      border:var(--border); border-radius:var(--radius); background:#fff; box-shadow:var(--shadow); padding:.6rem;
    }
    @media (max-width: 980px){ .card { grid-template-columns: 1fr; } }
    .carousel { position:relative; background:#f6f7f9; min-height:220px; border-radius:.35rem; overflow:hidden; border:var(--border); }
    .carousel img { width:100%; height:100%; object-fit:cover; display:block; }
    .carousel .nav { position:absolute; top:50%; transform:translateY(-50%); background:#fff; border:var(--border); border-radius:999px; padding:.2rem .4rem; }
    .carousel .prev { left:.25rem; } .carousel .next { right:.25rem; }
    .carousel .indicator { position:absolute; bottom:.35rem; left:50%; transform:translateX(-50%); font-size:.8rem; padding:.05rem .5rem; border:var(--border); border-radius:999px; background:#fff; }

    .title { margin:.1rem 0; font-size:1rem; }
    .desc { margin:.1rem 0; color:var(--muted); font-size:.9rem; }
    .tags { display:flex; flex-wrap:wrap; gap:.35rem; margin:.25rem 0; }
    .tag { display:inline-flex; padding:.1rem .45rem; border-radius:999px; background:var(--badge); border:var(--border); font-size:.78rem; color:#374151; }
    .price { font-weight:600; font-size:1rem; }
    .suggestion { display:flex; align-items:center; gap:.5rem; padding:.3rem .45rem; border:var(--border); border-radius:.35rem; background:#fafafa; font-size:.9rem; }
    .suggestion small { color:var(--muted); font-size:.78rem; }
    .actions { display:flex; gap:.5rem; flex-wrap:wrap; margin-top:.25rem; }
    .muted { color:var(--muted); font-size:.85rem; }

    details.compact { border:var(--border); border-radius:.35rem; padding:.35rem .5rem; background:#fff; }
    details.compact > summary { list-style:none; cursor:pointer; font-weight:600; }
    details.compact[open] > summary { margin-bottom:.35rem; }

    /* Comparador */
    .compare-wrap { overflow-x:auto; border:var(--border); border-radius:var(--radius); background:#fff; }
    table.compare { border-collapse:separate; border-spacing:0; width:100%; min-width:720px; }
    .compare th, .compare td { border-bottom:var(--border); padding:.45rem .5rem; vertical-align:top; background:#fff; font-size:.92rem; }
    .compare thead th { position:sticky; top:0; background:#f9fafb; z-index:1; }
    .compare tbody tr:nth-child(even) td { background:#fcfcfc; }
    .sticky { position:sticky; left:0; background:#f9fafb; z-index:2; border-right:var(--border); min-width:170px; }

    :focus-visible { outline:var(--focus); outline-offset:2px; }
  </style>
</head>
<body>
  <header>
    <h1>Catálogo de Impresoras — Vista compacta</h1>
    <div class="toolbar" role="region" aria-label="Controles">
      <input id="searchInput" type="search" placeholder="Buscar (marca, modelo, característica) — tecla / para enfocar" aria-label="Buscar" />
      <select id="brandFilter" aria-label="Marca"><option value="">Todas las marcas</option></select>
      <select id="typeFilter" aria-label="Tipo"><option value="">Todos los tipos</option></select>
      <select id="sortSelect" aria-label="Orden">
        <option value="name_asc">Nombre A-Z</option>
        <option value="price_asc">Precio ↑</option>
        <option value="price_desc">Precio ↓</option>
      </select>
      <div class="status" id="status" role="status" aria-live="polite">Cargando…</div>
      <button id="clearBtn" class="link-btn" type="button" title="Limpiar filtros">Limpiar</button>
    </div>
  </header>

  <div class="layout">
    <!-- Lista rápida -->
    <aside class="quick" aria-label="Lista rápida de impresoras">
      <header><strong>Resultados</strong> — <span class="muted">clic para seleccionar · Alt+←/→ navega</span></header>
      <ul id="quickList"></ul>
    </aside>

    <main class="content-area" style="display:grid; gap:.75rem;">
      <!-- Vista unitaria -->
      <section aria-label="Impresora seleccionada">
        <details class="compact" open>
          <summary>Impresora seleccionada</summary>
          <div id="primaryContainer"></div>
        </details>
      </section>

      <!-- Comparador plegable -->
      <section aria-label="Comparador">
        <details id="compareDetails" class="compact">
          <summary id="compareSummary">Comparar (0)</summary>
          <div style="display:grid; grid-template-columns: 1fr auto auto; gap:.5rem; align-items:center; margin-bottom:.5rem;">
            <select id="compareSelect" multiple size="4" aria-label="Selecciona 1–3 para comparar"></select>
            <button id="addToCompareBtn" class="btn" type="button" title="Añadir seleccionadas">Añadir</button>
            <button id="clearCompareBtn" class="btn" type="button" title="Vaciar comparación">Vaciar</button>
          </div>
          <div id="compareWrap" class="compare-wrap" aria-live="polite"></div>
        </details>
      </section>
    </main>
  </div>

  <!-- Plantilla de tarjeta compacta -->
  <template id="tpl-card">
    <article class="card">
      <div class="carousel" tabindex="0" aria-label="Galería de imágenes" aria-live="polite">
        <button class="btn nav prev" type="button" aria-label="Imagen anterior">◀</button>
        <img class="slide" loading="lazy" decoding="async" alt="" />
        <div class="indicator" aria-live="polite" aria-atomic="true">1/1</div>
        <button class="btn nav next" type="button" aria-label="Imagen siguiente">▶</button>
      </div>
      <div>
        <h3 class="title"><span class="name"></span></h3>
        <p class="desc"></p>
        <div class="tags">
          <span class="tag brand"></span>
          <span class="tag type"></span>
          <span class="tag stock"></span>
          <span class="tag price"></span>
        </div>
        <div class="suggestion"><span class="suggestion-text"></span><small class="suggestion-source"></small></div>

        <details class="compact" style="margin-top:.4rem;">
          <summary>Más detalles</summary>
          <ul class="features" style="margin:.35rem 0 .1rem 1.1rem;"></ul>
          <div class="actions" style="margin-top:.25rem;">
            <a class="btn link" target="_blank" rel="noopener">Ver en mi sitio</a>
            <button class="btn add-to-compare" type="button">Añadir a comparación</button>
          </div>
          <div class="muted" style="margin-top:.25rem;">Última actualización: <span class="updated"></span></div>
        </details>
      </div>
    </article>
  </template>

  <footer style="padding:.75rem; border-top:var(--border); color:var(--muted); font-size:.9rem;">
    Densa, accesible y sin dependencias. Atajos: "/" buscar · Alt+←/→ navegar · "c" comparar.
  </footer>

  <script>
    // =========================================================================
    // CONFIG
    // =========================================================================
    const CONFIG = {
      FORCE_SOURCE: "csv",
      SHEET_JSON_URL: "https://script.google.com/.../exec",
      SHEET_CSV_URL: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTZ-GFIahnmzB09C1GWCvAs1PaNXmpN2_Ed5taWtseTRlqx0P8-ZKJ28TOsvziFOw/pub?gid=128232950&single=true&output=csv",
      TEMPORADA_CLASES: { inicio: "2025-02-15", fin: "2025-03-31" },
      CACHE_TTL_MS: 1000 * 60 * 60 * 6,
      HEADER_ALIASES: {
        id:["ID","uuid","Uid","id_producto"],
        marca:["Marca","brand","Brand","Fabricante"],
        modelo:["Modelo","model","Model"],
        nombre:["Nombre","titulo","Título","producto","Producto"],
        tipo:["Tipo","tecnologia","Tecnología","technology","Tecnologia"],
        descripcion_corta:["descripcion","Descripción","descripcion breve","Descripción corta","resumen"],
        caracteristicas:["caracteristicas","Características","features","especificaciones","atributos"],
        imagenes:["imagenes","Imágenes","fotos","Fotos","images","image_urls","galeria","Galería","Imagen 1","Imagen1"],
        precio:["Precio","price","Price","importe","valor","coste","costo"],
        moneda:["Moneda","currency","Currency"],
        url_producto:["url","URL","enlace","link","Link","url producto","URL producto","producto_url"],
        stock:["Stock","disponibilidad","availability","inventario","estado stock"],
        uso_recomendado:["uso","Uso","segmento","Uso recomendado","target"],
        sugerencia_compra:["sugerencia","Sugerencia compra","recomendacion","Recomendación"],
        ultima_actualizacion:["Última actualización","actualizado","update_date","last_update","fecha actualización"],
      },
    };
    const CACHE_KEY = "impresorasCache:v3";
    const MAX_IMAGES_PER_CARD = 6;
    const MAX_COMPARE_TOTAL = 4;
    const MAX_QUICKLIST = 250;

    // =========================================================================
    // ESTADO
    // =========================================================================
    const state = {
      raw: [],
      items: [],
      medianaPorGrupo: {},
      filters: { search:"", marca:"", tipo:"", sort:"name_asc" },
      selectedId: "",
      compareIds: [],
    };

    // =========================================================================
    // UTILIDADES
    // =========================================================================
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const debounce = (fn, d=250) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),d); }; };
    const withinDateRange = (_d, r) => { const t=new Date(), s=new Date(r.inicio+"T00:00:00"), e=new Date(r.fin+"T23:59:59"); return t>=s && t<=e; };
    function parsePrice(v){ if(v==null||v==="")return null; const s=String(v).trim().replace(/\s+/g,"").replace(/(?<=\d)[.,](?=\d{3}\b)/g,"").replace(",","."); const n=Number(s); return Number.isFinite(n)?n:null; }
    function formatPrice(n,c){ if(n==null)return""; try{ if(c) return new Intl.NumberFormat(undefined,{style:"currency",currency:c}).format(n);}catch(_){} return new Intl.NumberFormat(undefined).format(n)+(c?` ${c}`:""); }
    function parseCSVToObjects(txt){ const rows=[]; let i=0,field="",row=[],q=false; const endF=()=>{row.push(field);field="";}, endR=()=>{rows.push(row);row=[];}; while(i<txt.length){const c=txt[i]; if(q){ if(c=='"'){ if(txt[i+1]=='"'){field+='"';i++;} else q=false;} else field+=c;} else { if(c=='"') q=true; else if(c==",") endF(); else if(c=="\n"){endF();endR();} else if(c!="\r") field+=c; } i++; } endF(); endR(); const headers=rows.shift()?.map(h=>(h||"").trim())||[]; return rows.filter(r=>r.some(v=>(v||"").trim()!=="")).map(r=>{const o={}; headers.forEach((h,idx)=>o[h]=(r[idx]??"").trim()); return o;}); }
    const initials = (a,b="") => { const p=[a,b].filter(Boolean).join(" ").split(/\s+/).filter(Boolean); return (p[0]?.[0]||"P").toUpperCase() + (p[1]?.[0]||"R").toUpperCase(); };
    const placeholderDataURI = (t="PR") => "data:image/svg+xml;charset=utf-8,"+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="800"><rect width="100%" height="100%" fill="#e5e7eb"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="system-ui" font-size="160" fill="#6b7280" font-weight="700">${t}</text></svg>`);
    const escapeHTML = s => s.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;");

    // Aliases y extracción flexible
    const _normKey = s => String(s||"").normalize?.("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9]+/g,"").trim();
    const _buildHeaderIndex = r => { const i={}; Object.keys(r||{}).forEach(k=>i[_normKey(k)]=k); return i; };
    const _makeReader = idx => (row, want) => { const c=[want,...(CONFIG.HEADER_ALIASES?.[want]||[])]; for(const w of c){const real=idx[_normKey(w)]; if(real && row[real]!=null && String(row[real]).trim()!=="") return String(row[real]).trim();} return ""; };
    function _extractImages(row, idx){ const d=_makeReader(idx)(row,"imagenes"); if(d) return d; const imgs=[]; for(const k of Object.keys(row)){const nk=_normKey(k); if(nk.startsWith("imagen")||nk.startsWith("foto")||nk.startsWith("image")){const v=String(row[k]??"").trim(); if(v) imgs.push(v);} } return imgs.join(", "); }
    function _extractFeatures(row, idx){ const d=_makeReader(idx)(row,"caracteristicas"); if(d) return d; const fs=[]; for(const k of Object.keys(row)){const nk=_normKey(k); if(nk.startsWith("caracteristica")||nk.startsWith("feature")||nk==="caracteristicas"){const v=String(row[k]??"").trim(); if(v) fs.push(v);} } return fs.join("|"); }
    const _normalizeStock = s => { const v=String(s||"").toLowerCase(); if(!v) return ""; if(/(sin\s*stock|agotad|no\s*disponible)/.test(v))return"sin_stock"; if(/(bajo|poco)/.test(v))return"bajo"; if(/(pedido|order)/.test(v))return"bajo_pedido"; if(/(en\s*stock|disponible|stock)/.test(v))return"en_stock"; return v; };
    function remapRowsWithAliases(rows){ if(!rows||!rows.length) return rows; const idx=_buildHeaderIndex(rows[0]), read=_makeReader(idx);
      return rows.map(r=>({ ...r,
        id: read(r,"id")||r.id, marca: read(r,"marca")||r.marca, modelo: read(r,"modelo")||r.modelo,
        nombre: read(r,"nombre")||r.nombre, tipo: read(r,"tipo")||r.tipo,
        descripcion_corta: read(r,"descripcion_corta")||r.descripcion_corta,
        caracteristicas: _extractFeatures(r,idx), imagenes: _extractImages(r,idx),
        precio: read(r,"precio")||r.precio, moneda: read(r,"moneda")||r.moneda,
        url_producto: read(r,"url_producto")||r.url_producto||read(r,"url")||"",
        stock: _normalizeStock(read(r,"stock")||r.stock),
        uso_recomendado: read(r,"uso_recomendado")||r.uso_recomendado,
        sugerencia_compra: read(r,"sugerencia_compra")||r.sugerencia_compra,
        ultima_actualizacion: read(r,"ultima_actualizacion")||r.ultima_actualizacion
      }));
    }

    // =========================================================================
    // FETCH + CACHE
    // =========================================================================
    async function tryFetchJSON(url){ if(!url||url.includes(".../exec")) throw new Error("JSON URL placeholder"); const r=await fetch(url,{headers:{"Accept":"application/json"}}); if(!r.ok) throw new Error("HTTP "+r.status); const d=await r.json(); const rows=Array.isArray(d)?d:(Array.isArray(d.data)?d.data:[]); if(!rows.length) throw new Error("JSON vacío"); return rows; }
    async function tryFetchCSV(url){ const bust=url+(url.includes("?")?"&":"?")+"_cb="+Date.now(); const r=await fetch(bust,{headers:{"Accept":"text/csv"}}); if(!r.ok) throw new Error("HTTP "+r.status); const t=await r.text(); const rows=parseCSVToObjects(t); if(!rows.length) throw new Error("CSV vacío"); return rows; }
    const saveCache = items => { try{ localStorage.setItem(CACHE_KEY, JSON.stringify({ts:Date.now(), items})) }catch(_){} };
    function loadCache(){ try{ const raw=localStorage.getItem(CACHE_KEY); if(!raw) return null; const p=JSON.parse(raw); if(!p||!Array.isArray(p.items)) return null; if(Date.now()-p.ts>CONFIG.CACHE_TTL_MS) return null; return p.items; }catch(_){ return null; } }
    async function loadDataWithFallback(){
      const st=$("#status"); st.textContent="Cargando…";
      const c=loadCache(); if(c){ st.textContent=`Cache (${c.length})`; return c; }
      try{
        if(CONFIG.FORCE_SOURCE==="json"){ const j=await tryFetchJSON(CONFIG.SHEET_JSON_URL); st.textContent=`JSON (${j.length})`; saveCache(j); return j; }
        if(CONFIG.FORCE_SOURCE==="csv"){ const v=await tryFetchCSV(CONFIG.SHEET_CSV_URL); st.textContent=`CSV (${v.length})`; saveCache(v); return v; }
        try{ const j=await tryFetchJSON(CONFIG.SHEET_JSON_URL); st.textContent=`JSON (${j.length})`; saveCache(j); return j; }catch(e){ st.textContent=`JSON falló → CSV…`; const v=await tryFetchCSV(CONFIG.SHEET_CSV_URL); st.textContent=`CSV (${v.length})`; saveCache(v); return v; }
      }catch(e){ st.textContent=`Fallo fuentes. Demo local.`; return SAMPLE_DATA; }
    }

    // =========================================================================
    // TRANSFORMACIÓN + SUGERENCIAS
    // =========================================================================
    function normalizeRow(row){
      const it={...row};
      it.marca=(it.marca||"").trim(); it.modelo=(it.modelo||"").trim();
      it.nombre=(it.nombre||"").trim() || `${it.marca} ${it.modelo}`.trim();
      it.tipo=(it.tipo||"").trim(); it.descripcion_corta=(it.descripcion_corta||"").trim();
      it._features=(it.caracteristicas||"").split("|").map(x=>x.trim()).filter(Boolean);
      let imgs=(it.imagenes||"").split(",").map(x=>x.trim()).filter(Boolean);
      if(imgs.length>MAX_IMAGES_PER_CARD) imgs=imgs.slice(0,MAX_IMAGES_PER_CARD);
      if(!imgs.length) imgs=[placeholderDataURI(initials(it.marca,it.modelo))];
      it._images=imgs;
      it._precio=parsePrice(it.precio); it.moneda=(it.moneda||"").trim().toUpperCase();
      it.url_producto=(it.url_producto||"").trim(); it.stock=(it.stock||"").trim();
      it.uso_recomendado=(it.uso_recomendado||"").trim(); it.sugerencia_compra=(it.sugerencia_compra||"").trim();
      it.ultima_actualizacion=(it.ultima_actualizacion||"").trim();
      it.id=(it.id||`${it.marca}-${it.modelo}`||crypto.randomUUID?.()||Math.random().toString(36).slice(2)).trim();
      return it;
    }
    const computeMedian = arr => { if(!arr.length) return null; const a=arr.slice().sort((x,y)=>x-y); const m=Math.floor(a.length/2); return a.length%2?a[m]:(a[m-1]+a[m])/2; };
    function buildMedians(items){ const g=new Map(); for(const it of items){ if(it._precio==null) continue; const k=`${it.marca}|${it.tipo}`; if(!g.has(k)) g.set(k,[]); g.get(k).push(it._precio); } const out={}; for(const [k,v] of g) out[k]=computeMedian(v); return out; }
    function computeSuggestion(it, med, temporada){
      if(it.sugerencia_compra) return {text:it.sugerencia_compra, source:"Hoja de cálculo"};
      if(it.stock==="bajo") return {text:"Comprar pronto: stock limitado", source:"stock=bajo"};
      if(it.stock==="sin_stock") return {text:"Esperar reposición", source:"stock=sin_stock"};
      const key=`${it.marca}|${it.tipo}`, m=med[key];
      if(it._precio!=null && m!=null && it._precio<m) return {text:"Buen momento para comprar", source:"precio < mediana(marca+tipo)"};
      if(it.uso_recomendado==="estudiante" && withinDateRange(new Date(), CONFIG.TEMPORADA_CLASES)) return {text:"Comprar antes de inicio de clases", source:"temporada estudiantes"};
      return {text:"Comprar según necesidad", source:"sin condición específica"};
    }
    function transformAll(rows){
      const canon=remapRowsWithAliases(rows);
      const items=canon.map(normalizeRow);
      const med=buildMedians(items);
      for(const it of items){ const s=computeSuggestion(it,med,CONFIG.TEMPORADA_CLASES); it._sugerencia=s.text; it._sugerencia_source="Regla: "+s.source; }
      return { items, medians: med };
    }

    // =========================================================================
    // FILTROS + BUSCADOR
    // =========================================================================
    function buildFilters(items){
      const b=$("#brandFilter"), t=$("#typeFilter"); b.length=1; t.length=1;
      [...new Set(items.map(i=>i.marca).filter(Boolean))].sort((a,b)=>a.localeCompare(b)).forEach(v=>{ const o=document.createElement("option"); o.value=v; o.textContent=v; b.appendChild(o); });
      [...new Set(items.map(i=>i.tipo ).filter(Boolean))].sort((a,b)=>a.localeCompare(b)).forEach(v=>{ const o=document.createElement("option"); o.value=v; o.textContent=v; t.appendChild(o); });
    }
    function filteredItems(){
      const q=state.filters.search.toLowerCase().trim(), marca=state.filters.marca, tipo=state.filters.tipo;
      let out=state.items.filter(it=>{
        if(marca && it.marca!==marca) return false;
        if(tipo  && it.tipo !==tipo ) return false;
        if(q){ const hay=[it.marca,it.modelo,it.nombre,it.tipo,it.descripcion_corta,it._features.join(" ")].join(" ").toLowerCase(); if(!hay.includes(q)) return false; }
        return true;
      });
      const sort=state.filters.sort;
      if(sort==="name_asc") out.sort((a,b)=>a.nombre.localeCompare(b.nombre,undefined,{sensitivity:"base"}));
      else if(sort==="price_asc") out.sort((a,b)=>(a._precio??Infinity)-(b._precio??Infinity));
      else if(sort==="price_desc") out.sort((a,b)=>(b._precio??-Infinity)-(a._precio??-Infinity));
      return out;
    }

    // =========================================================================
    // LISTA RÁPIDA + VISTA + COMPARADOR
    // =========================================================================
    function renderQuickList(){
      const ul=$("#quickList"); ul.innerHTML="";
      const items=filteredItems().slice(0, MAX_QUICKLIST);
      const frag=document.createDocumentFragment();
      for(const it of items){
        const li=document.createElement("li");
        li.setAttribute("role","button"); li.tabIndex=0; li.dataset.id=it.id;
        if(it.id===state.selectedId) li.setAttribute("aria-current","true");
        li.innerHTML=`<div>
            <div class="name">${escapeHTML(it.nombre)}</div>
            <div class="meta"><span class="chip">${escapeHTML(it.marca)}</span> <span class="chip">${escapeHTML(it.tipo||"")||"—"}</span></div>
          </div>
          <div class="row-actions">
            <div class="price">${it._precio!=null?escapeHTML(formatPrice(it._precio,it.moneda)):""}</div>
            <button class="btn add addRow" type="button" title="Añadir a comparación" aria-label="Añadir a comparación">＋</button>
          </div>`;
        li.addEventListener("click", e=>{ if(!(e.target.closest(".addRow"))){ state.selectedId=it.id; syncSelectionControls(); renderPrimary(); renderCompare(); highlightQuickList(); }});
        li.addEventListener("keydown", e=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); state.selectedId=it.id; syncSelectionControls(); renderPrimary(); renderCompare(); highlightQuickList(); }});
        li.querySelector(".addRow").addEventListener("click", e=>{ e.stopPropagation(); addToCompare([it.id]); openCompareIfHasItems(); });
        frag.appendChild(li);
      }
      if(!items.length){
        const li=document.createElement("li"); li.innerHTML='<span class="meta">No hay resultados.</span>'; frag.appendChild(li);
      }
      ul.appendChild(frag);
      $("#status").textContent=`Resultados: ${items.length} · Total catálogo: ${state.items.length}`;
      if(!state.selectedId && items[0]){ state.selectedId=items[0].id; renderPrimary(); renderCompare(); highlightQuickList(); }
    }
    function highlightQuickList(){
      $$("#quickList li").forEach(li=>li.removeAttribute("aria-current"));
      const cur=$(`#quickList li[data-id="${CSS.escape(state.selectedId)}"]`); if(cur) cur.setAttribute("aria-current","true");
    }
    function syncSelectionControls(){ /* la UI actual no tiene dropdown de impresora; nada que sincronizar */ }

    function renderPrimary(){
      const c=$("#primaryContainer"); c.innerHTML="";
      const it=state.items.find(x=>x.id===state.selectedId);
      if(!it){ c.innerHTML='<div class="muted">Selecciona una impresora.</div>'; return; }
      const node=renderCard(it);
      $(".add-to-compare", node).addEventListener("click",()=>{ addToCompare([it.id]); openCompareIfHasItems(); });
      c.appendChild(node);
      highlightQuickList();
    }

    function renderCard(item){
      const tpl=$("#tpl-card"); const el=tpl.content.firstElementChild.cloneNode(true);
      // Carrusel
      const car=el.querySelector(".carousel"), img=el.querySelector(".slide"), ind=el.querySelector(".indicator");
      const prev=el.querySelector(".prev"), next=el.querySelector(".next"); const images=item._images.slice(0,MAX_IMAGES_PER_CARD); let i=0;
      const update=()=>{ img.src=images[i]; img.alt=`Foto ${i+1}/${images.length} — ${item.nombre}`; ind.textContent=`${i+1}/${images.length}`; };
      const goP=()=>{ i=(i-1+images.length)%images.length; update(); }, goN=()=>{ i=(i+1)%images.length; update(); };
      prev.addEventListener("click",goP); next.addEventListener("click",goN);
      car.addEventListener("keydown",e=>{ if(e.key==="ArrowLeft"){e.preventDefault();goP();} if(e.key==="ArrowRight"){e.preventDefault();goN();} });
      update();

      // Datos
      el.querySelector(".name").textContent=item.nombre;
      el.querySelector(".desc").textContent=item.descripcion_corta||"";
      el.querySelector(".brand").textContent=item.marca||"—";
      el.querySelector(".type").textContent=item.tipo||"—";
      el.querySelector(".stock").textContent=({en_stock:"En stock",bajo:"Stock bajo",sin_stock:"Sin stock",bajo_pedido:"Bajo pedido"}[item.stock]||item.stock||"—");
      el.querySelector(".price").textContent=item._precio!=null?formatPrice(item._precio,item.moneda):"";
      const feats=el.querySelector(".features"); feats.innerHTML=""; for(const f of item._features){ const li=document.createElement("li"); li.textContent=f; feats.appendChild(li); }
      const sug=el.querySelector(".suggestion"); sug.querySelector(".suggestion-text").textContent=item._sugerencia; sug.querySelector(".suggestion-source").textContent=item._sugerencia_source; sug.title=item._sugerencia_source;
      const a=el.querySelector(".link"); if(item.url_producto){ a.href=item.url_producto; } else { a.textContent="Sin enlace"; a.href="javascript:void(0)"; a.setAttribute("aria-disabled","true"); }
      el.querySelector(".updated").textContent=item.ultima_actualizacion||"—";
      return el;
    }

    function addToCompare(ids){
      const allowed=new Set(filteredItems().map(x=>x.id));
      const valid=ids.filter(id=>id && id!==state.selectedId && allowed.has(id));
      for(const id of valid) if(!state.compareIds.includes(id)) state.compareIds.push(id);
      const allowedExtras=Math.max(0, MAX_COMPARE_TOTAL-1);
      state.compareIds=state.compareIds.slice(0, allowedExtras);
      renderCompare();
    }
    function removeFromCompare(id){ state.compareIds=state.compareIds.filter(x=>x!==id); renderCompare(); }
    function openCompareIfHasItems(){ const det=$("#compareDetails"); if(state.compareIds.length>0 && !det.open) det.open=true; }
    function renderCompare(){
      const wrap=$("#compareWrap"); wrap.innerHTML="";
      const primary=state.items.find(x=>x.id===state.selectedId); if(!primary){ wrap.innerHTML='<div class="muted">Selecciona una impresora.</div>'; return; }
      const cols=[primary, ...state.compareIds.map(id=>state.items.find(x=>x.id===id)).filter(Boolean)];
      updateCompareSummary(cols.length-1);
      wrap.appendChild(buildCompareTable(cols));
      // Candidatos en select múltiple
      refreshCompareCandidates();
    }
    function updateCompareSummary(n){ $("#compareSummary").textContent=`Comparar (${n})`; }

    function buildCompareTable(items){
      const t=document.createElement("table"); t.className="compare"; const thead=t.createTHead(); const hrow=thead.insertRow();
      const h0=document.createElement("th"); h0.className="sticky"; h0.textContent="Especificación"; hrow.appendChild(h0);
      for(const it of items){
        const th=document.createElement("th");
        th.innerHTML=`<div><strong>${escapeHTML(it.nombre)}</strong></div>
          <div class="muted">${escapeHTML(it.marca)} ${escapeHTML(it.modelo)}</div>
          <div style="white-space:nowrap;margin-top:.25rem;">
            ${it.url_producto?`<a class="btn" href="${it.url_producto}" target="_blank" rel="noopener">Ver</a>`:`<span class="chip">Sin enlace</span>`}
            ${it.id!==state.selectedId?` <button class="btn remove-col" data-id="${it.id}" type="button">Quitar</button>`:` <span class="chip">Seleccionada</span>`}
          </div>`;
        hrow.appendChild(th);
      }
      const tb=t.createTBody();
      const add=(label,get)=>{ const tr=tb.insertRow(); const th=document.createElement("th"); th.className="sticky"; th.textContent=label; tr.appendChild(th); for(const it of items){ const td=tr.insertCell(); td.innerHTML=get(it)??"—"; } };
      items.forEach(it=>{ it._precioFmt=it._precio!=null?formatPrice(it._precio,it.moneda):"—"; });
      add("Nombre", it=>escapeHTML(it.nombre));
      add("Marca", it=>escapeHTML(it.marca));
      add("Modelo", it=>escapeHTML(it.modelo));
      add("Tipo", it=>escapeHTML(it.tipo||"—"));
      add("Precio", it=>escapeHTML(it._precioFmt));
      add("Stock", it=>escapeHTML(it.stock||"—"));
      add("Uso recomendado", it=>escapeHTML(it.uso_recomendado||"—"));
      add("Sugerencia", it=>escapeHTML(it._sugerencia||"—"));
      // Unión de características
      const feats=new Set(); items.forEach(i=>i._features.forEach(f=>feats.add(f)));
      [...feats].sort((a,b)=>a.localeCompare(b)).forEach(f=> add("Caract.: "+f, it=> it._features.includes(f)?"✓":"—") );
      add("Última actualización", it=>escapeHTML(it.ultima_actualizacion||"—"));
      $$(".remove-col", t).forEach(b=>b.addEventListener("click", e=>removeFromCompare(e.currentTarget.dataset.id)));
      return t;
    }

    function refreshCompareCandidates(){
      const sel=$("#compareSelect");
      const allowed=filteredItems().filter(x=>x.id!==state.selectedId);
      const prev=new Set(Array.from(sel.selectedOptions).map(o=>o.value));
      sel.innerHTML="";
      for(const it of allowed){ const o=document.createElement("option"); o.value=it.id; o.textContent=it.nombre; if(prev.has(it.id)) o.selected=true; sel.appendChild(o); }
    }

    // =========================================================================
    // EVENTOS + ATAJOS
    // =========================================================================
    function attachEvents(){
      $("#searchInput").addEventListener("input", debounce(e=>{ state.filters.search=e.target.value; updateUI(); },300));
      $("#brandFilter").addEventListener("change", e=>{ state.filters.marca=e.target.value; updateUI(); });
      $("#typeFilter").addEventListener("change",  e=>{ state.filters.tipo =e.target.value; updateUI(); });
      $("#sortSelect").addEventListener("change",  e=>{ state.filters.sort =e.target.value; updateUI(); });
      $("#clearBtn").addEventListener("click", ()=>{ state.filters={search:"",marca:"",tipo:"",sort:"name_asc"}; $("#searchInput").value=""; $("#brandFilter").value=""; $("#typeFilter").value=""; $("#sortSelect").value="name_asc"; state.compareIds=[]; updateUI(); });

      $("#addToCompareBtn").addEventListener("click", ()=>{ const ids=Array.from($("#compareSelect").selectedOptions).map(o=>o.value); addToCompare(ids); openCompareIfHasItems(); });
      $("#clearCompareBtn").addEventListener("click", ()=>{ state.compareIds=[]; renderCompare(); updateCompareSummary(0); });

      // Atajos
      document.addEventListener("keydown", (e)=>{
        if(e.key==="/" && !/input|textarea|select/i.test(document.activeElement.tagName)){ e.preventDefault(); $("#searchInput").focus(); }
        if(e.altKey && (e.key==="ArrowRight"||e.key==="ArrowLeft")){
          e.preventDefault();
          const list=filteredItems(); const idx=list.findIndex(x=>x.id===state.selectedId);
          if(idx>-1){ const nextIdx = e.key==="ArrowRight" ? (idx+1)%list.length : (idx-1+list.length)%list.length;
            state.selectedId=list[nextIdx].id; renderPrimary(); renderCompare(); highlightQuickList(); }
        }
        if(e.key.toLowerCase()==="c"){ const det=$("#compareDetails"); det.open=!det.open; }
      });
    }

    // =========================================================================
    // UI FLOW
    // =========================================================================
    function updateUI(){
      renderQuickList();
      // depurar compareIds si ya no están disponibles
      const allowed=new Set(filteredItems().map(x=>x.id));
      state.compareIds=state.compareIds.filter(id=>allowed.has(id) && id!==state.selectedId);
      renderPrimary();
      renderCompare();
    }

    // =========================================================================
    // DEMO DATASET (para fallback)
    // =========================================================================
    const SAMPLE_DATA = [
      { id:"hp-415", marca:"HP", modelo:"Ink Tank 415", nombre:"", tipo:"inyeccion", descripcion_corta:"Multifunción con Wi-Fi para hogar y tareas escolares.", caracteristicas:"Wi-Fi|Imprime/Escanea/Copia|A4|Tanque de tinta", imagenes:"", precio:"149999", moneda:"ARS", url_producto:"", stock:"bajo", uso_recomendado:"estudiante", sugerencia_compra:"", ultima_actualizacion:"2025-08-01" },
      { id:"epson-l3250", marca:"Epson", modelo:"L3250", nombre:"Epson EcoTank L3250", tipo:"multifunción", descripcion_corta:"EcoTank con impresión económica y conectividad móvil.", caracteristicas:"EcoTank|Wi-Fi|Imprime/Escanea/Copia|A4", imagenes:"", precio:"189999", moneda:"ARS", url_producto:"", stock:"en_stock", uso_recomendado:"hogar", sugerencia_compra:"", ultima_actualizacion:"2025-07-20" },
      { id:"brother-hl-l2370dw", marca:"Brother", modelo:"HL-L2370DW", nombre:"", tipo:"láser", descripcion_corta:"Láser monocromática rápida con dúplex y Wi-Fi.", caracteristicas:"Láser|Dúplex|Wi-Fi|A4|Monocromo", imagenes:"", precio:"214999", moneda:"ARS", url_producto:"", stock:"sin_stock", uso_recomendado:"oficina", sugerencia_compra:"", ultima_actualizacion:"2025-08-05" },
    ];

    // =========================================================================
    // INIT
    // =========================================================================
    (async function init(){
      try{
        const rows = await loadDataWithFallback();
        const { items, medians } = transformAll(rows);
        state.items = items;
        state.medianaPorGrupo = medians;
        buildFilters(items);
        attachEvents();
        updateUI();
      }catch(err){
        console.error(err);
        $("#status").textContent="Error al cargar datos";
        $("#primaryContainer").innerHTML='<div class="muted">Ocurrió un error al obtener los datos.</div>';
      }
    })();
  </script>
</body>
</html>
